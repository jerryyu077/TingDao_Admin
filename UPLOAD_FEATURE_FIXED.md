# Admin ä¸Šä¼ åŠŸèƒ½ä¿®å¤è¯´æ˜

## âœ… å·²å®Œæˆçš„ä¿®æ”¹

### 1. å‰ç«¯ä¿®æ”¹ (`add-sermon.html`)

#### ä¿®å¤éŸ³é¢‘ä¸Šä¼ 
- âœ… é›†æˆ R2 éŸ³é¢‘ä¸Šä¼  API (`/api/v1/upload/audio`)
- âœ… ä¸Šä¼ å‰æ˜¾ç¤ºè¿›åº¦æç¤ºï¼š"ä¸Šä¼ éŸ³é¢‘æ–‡ä»¶..."
- âœ… è·å–çœŸå®çš„éŸ³é¢‘ URL è€Œä¸æ˜¯å ä½ç¬¦

#### ä¿®å¤å°é¢å›¾ç‰‡ä¸Šä¼ 
- âœ… é›†æˆ R2 å›¾ç‰‡ä¸Šä¼  API (`/api/v1/upload/image`)
- âœ… ä¸Šä¼ å‰æ˜¾ç¤ºè¿›åº¦æç¤ºï¼š"ä¸Šä¼ å°é¢å›¾ç‰‡..."
- âœ… è·å–çœŸå®çš„å›¾ç‰‡ URL è€Œä¸æ˜¯ base64

#### ä¿®å¤è®²é“æ•°æ®æäº¤
- âœ… ç§»é™¤ä¸å¿…è¦çš„å­—æ®µ (`speaker_name`, `speaker`, `submitter` ç­‰)
- âœ… æ·»åŠ  `audio_size` å’Œ `audio_format` å­—æ®µ
- âœ… è®¾ç½® `status` ä¸º 'pending'ï¼ˆå¾…å®¡æ ¸ï¼‰
- âœ… åç«¯è‡ªåŠ¨ä» token è·å– `submitter_id`

### 2. åç«¯ä¿®æ”¹

#### ä¸´æ—¶ç¦ç”¨è®¤è¯æ£€æŸ¥
ç”±äºæ•´ä¸ª Admin é¢æ¿å·²é€šè¿‡ Cloudflare Zero Trust ä¿æŠ¤ï¼Œä¸´æ—¶ç¦ç”¨äº†ä»¥ä¸‹ API çš„è®¤è¯æ£€æŸ¥ï¼š

- âœ… `/api/v1/upload/audio` - éŸ³é¢‘ä¸Šä¼ 
- âœ… `/api/v1/upload/image` - å›¾ç‰‡ä¸Šä¼   
- âœ… `/api/v1/sermons` (POST) - åˆ›å»ºè®²é“

æ‰€æœ‰è®¤è¯ä»£ç éƒ½å·²ä¿ç•™å¹¶æ³¨é‡Šï¼Œæ–¹ä¾¿æœªæ¥é‡æ–°å¯ç”¨ã€‚

#### åˆ›å»º Admin ç”¨æˆ·
- âœ… æ·»åŠ è¿ç§»è„šæœ¬ `009_ensure_admin_user.sql`
- âœ… åˆ›å»º ID ä¸º 'admin' çš„ç®¡ç†å‘˜ç”¨æˆ·
- âœ… æ‰€æœ‰é€šè¿‡ Admin é¢æ¿ä¸Šä¼ çš„è®²é“ï¼Œ`submitter_id` éƒ½ä¸º 'admin'

### 3. æ•°æ®åº“è¿ç§»
```sql
-- 009_ensure_admin_user.sql
INSERT OR IGNORE INTO users (id, username, email, name, password_hash, role, can_upload, created_at, updated_at)
VALUES ('admin', 'admin', 'admin@tingdao.app', 'Admin', '', 'admin', 1, datetime('now'), datetime('now'));
```

## ğŸ“‹ ä¸Šä¼ æµç¨‹

### å®Œæ•´çš„ä¸Šä¼ æµç¨‹
1. **å¡«å†™è¡¨å•** - æ ‡é¢˜ã€è®²å‘˜ã€æ—¥æœŸã€æ‘˜è¦ã€ç»æ–‡ã€æ ‡ç­¾ç­‰
2. **ä¸Šä¼ éŸ³é¢‘** - è°ƒç”¨ `/api/v1/upload/audio`ï¼Œä¸Šä¼ åˆ° R2
3. **ä¸Šä¼ å°é¢** - è°ƒç”¨ `/api/v1/upload/image`ï¼Œä¸Šä¼ åˆ° R2
4. **åˆ›å»ºè®°å½•** - è°ƒç”¨ `/api/v1/sermons` (POST)ï¼Œåˆ›å»ºè®²é“è®°å½•
5. **çŠ¶æ€è®¾ç½®** - è‡ªåŠ¨è®¾ç½®ä¸º 'pending'ï¼ˆå¾…å®¡æ ¸ï¼‰
6. **è·³è½¬åˆ—è¡¨** - æˆåŠŸåè·³è½¬åˆ°è®²é“åˆ—è¡¨é¡µ

### API è°ƒç”¨é¡ºåº
```
1. POST /api/v1/upload/audio
   â†“ è¿”å› audio_url
2. POST /api/v1/upload/image  
   â†“ è¿”å› cover_image_url
3. POST /api/v1/sermons
   â†“ åˆ›å»ºè®²é“è®°å½•ï¼ˆstatus: 'pending'ï¼‰
4. è·³è½¬åˆ° sermons.html
```

## ğŸ”„ å¦‚ä½•é‡æ–°å¯ç”¨è®¤è¯

å¦‚æœæœªæ¥éœ€è¦æ¢å¤ API è®¤è¯ï¼š

### 1. æ¢å¤ä¸Šä¼  API è®¤è¯ (`workers/src/routes/upload.js`)
```javascript
// å–æ¶ˆæ³¨é‡Šè¿™éƒ¨åˆ†ä»£ç 
const userId = getUserIdFromRequest(request);
if (!userId) {
  return error('æœªæˆæƒ', 'UNAUTHORIZED', 401);
}
```

### 2. æ¢å¤åˆ›å»ºè®²é“ API è®¤è¯ (`workers/src/routes/sermons.js`)
```javascript
// å–æ¶ˆæ³¨é‡Šè¿™éƒ¨åˆ†ä»£ç 
const userId = getUserIdFromRequest(request);
if (!userId) {
  return error('æœªæˆæƒ', 'UNAUTHORIZED', 401);
}
// åˆ é™¤è¿™è¡Œ
// const userId = 'admin';
```

## ğŸ“ æ³¨æ„äº‹é¡¹

1. **R2 å­˜å‚¨æ¡¶**: ç¡®ä¿ `STORAGE` ç»‘å®šå·²é…ç½®åˆ° R2 å­˜å‚¨æ¡¶
2. **å…¬å¼€è®¿é—®**: ç¡®ä¿ R2 å­˜å‚¨æ¡¶é…ç½®äº†å…¬å¼€è®¿é—®åŸŸå `media.tingdao.app`
3. **æ–‡ä»¶å¤§å°é™åˆ¶**:
   - éŸ³é¢‘: æœ€å¤§ 100MB
   - å›¾ç‰‡: æœ€å¤§ 5MB
4. **æ”¯æŒçš„æ ¼å¼**:
   - éŸ³é¢‘: MP3, M4A, WAV
   - å›¾ç‰‡: JPEG, PNG, WebP

## ğŸ§ª æµ‹è¯•æ­¥éª¤

1. è®¿é—® `admin.tingdao.app/add-sermon.html`
2. å¡«å†™æ‰€æœ‰å¿…å¡«å­—æ®µ
3. ä¸Šä¼ éŸ³é¢‘æ–‡ä»¶ï¼ˆ< 100MBï¼‰
4. ä¸Šä¼ å°é¢å›¾ç‰‡ï¼ˆ< 5MBï¼‰
5. ç‚¹å‡»"æäº¤è®²é“"
6. æŸ¥çœ‹æ§åˆ¶å°æ—¥å¿—ï¼Œç¡®è®¤ä¸Šä¼ æˆåŠŸ
7. è·³è½¬åˆ°è®²é“åˆ—è¡¨ï¼ŒæŸ¥çœ‹æ–°åˆ›å»ºçš„è®²é“ï¼ˆçŠ¶æ€ï¼šå¾…å®¡æ ¸ï¼‰
8. ç‚¹å‡»è®²é“è¿›å…¥è¯¦æƒ…é¡µï¼ŒéªŒè¯éŸ³é¢‘å’Œå°é¢æ˜¯å¦æ­£ç¡®

---

**æœ€åæ›´æ–°**: 2025-01-20
