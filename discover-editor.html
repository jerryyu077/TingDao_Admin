<!DOCTYPE html>
<html lang="zh-CN" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å‘ç°é¡µæ¨¡å—ç¼–è¾‘å™¨ - å¬é“åå°ç®¡ç†ç³»ç»Ÿ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/daisyui@4.4.19/dist/full.min.css" rel="stylesheet" type="text/css" />
    <script src="https://code.iconify.design/3/3.1.1/iconify.min.js"></script>
    <style>
        body {
            font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        }

        .sidebar-wrapper {
            width: 220px;
            flex-shrink: 0;
        }

        .sidebar-text {
            white-space: nowrap;
        }

        /* Module drag and drop */
        .module-content {
            transition: all 0.3s ease-in-out;
            overflow: hidden;
        }

        .module-content.collapsed {
            max-height: 0;
            opacity: 0;
            padding-top: 0;
            padding-bottom: 0;
        }

        .expand-icon {
            transition: transform 0.2s ease-in-out;
        }

        .expand-icon.rotated {
            transform: rotate(180deg);
        }

        .drag-handle:hover {
            background-color: rgba(0, 0, 0, 0.05);
            transform: scale(1.05);
        }

        .module-dragging {
            opacity: 0.5;
            transform: rotate(2deg);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        }

        .drop-zone {
            border: 2px dashed #3B82F6;
            background-color: rgba(59, 130, 246, 0.05);
        }

        /* Content item selection */
        .content-item {
            transition: all 0.15s ease-in-out;
            cursor: pointer;
        }

        .content-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .content-item.selected {
            border-color: #3B82F6;
            background-color: rgba(59, 130, 246, 0.05);
        }

        /* Tag item */
        .tag-item {
            cursor: move;
        }

        .tag-item:hover {
            background-color: rgba(59, 130, 246, 0.1);
        }
    </style>

    <!-- API Client -->
    <script src="js/api-config.js?v=20251104v5"></script>
    <script src="js/api-client.js?v=20251104v5"></script>
    <script src="js/api-services.js?v=20251104v5"></script>
    <script src="js/curation-api.js?v=20251104v5"></script>
    </head>
<body class="bg-base-200 flex flex-col min-h-screen">
    <div class="flex flex-1">
        <!-- Sidebar -->
        <aside class="sidebar-wrapper bg-base-100 border-r border-base-300">
            <div class="p-3 border-b border-base-300">
                <div class="flex items-center gap-2.5">
                    <div class="w-9 h-9 bg-primary rounded-lg flex items-center justify-center">
                        <span class="iconify text-white" data-icon="heroicons:home" data-width="20"></span>
                    </div>
                    <span class="sidebar-text text-lg font-semibold">å¬é“åå°</span>
                </div>
            </div>

            <ul class="menu menu-sm gap-1 p-3">
                <li><a href="dashboard.html"><span class="iconify" data-icon="heroicons:home" data-width="18"></span><span class="sidebar-text">ä»ªè¡¨ç›˜</span></a></li>
                
                <li>
                    <details>
                        <summary><span class="iconify text-blue-600" data-icon="heroicons:microphone" data-width="18"></span><span class="sidebar-text">è®²é“å†…å®¹</span></summary>
                        <ul>
                            <li><a href="sermons.html">è®²é“åˆ—è¡¨</a></li>
                            <li><a href="add-sermon.html">æ·»åŠ è®²é“</a></li>
                        </ul>
                    </details>
                </li>
                
                <li>
                    <details>
                        <summary><span class="iconify text-green-600" data-icon="heroicons:users" data-width="18"></span><span class="sidebar-text">è®²å‘˜ç®¡ç†</span></summary>
                        <ul>
                            <li><a href="speakers.html">è®²å‘˜åˆ—è¡¨</a></li>
                            <li><a href="add-speaker.html">æ·»åŠ è®²å‘˜</a></li>
                        </ul>
                    </details>
                </li>
                
                <li>
                    <details open>
                        <summary><span class="iconify text-purple-600" data-icon="heroicons:squares-plus" data-width="18"></span><span class="sidebar-text">å†…å®¹ç¼–æ’</span></summary>
                        <ul>
                            <li><a href="curation.html">ç¼–æ’æ¦‚è§ˆ</a></li>
                            <li><a href="home-editor.html">é¦–é¡µæ¨¡å—</a></li>
                            <li><a href="discover-editor.html" class="active">å‘ç°é¡µæ¨¡å—</a></li>
                            <li><a href="launch-screen-editor.html">å¼€å±é¡µæ¨¡å—</a></li>
                        </ul>
                    </details>
                </li>
                
                <li>
                    <details>
                        <summary><span class="iconify text-orange-600" data-icon="heroicons:user-group" data-width="18"></span><span class="sidebar-text">ç”¨æˆ·ç®¡ç†</span></summary>
                        <ul>
                            <li><a href="users.html">æ‰€æœ‰ç”¨æˆ·</a></li>
                        </ul>
                    </details>
                </li>
                
                <li>
                    <details>
                        <summary><span class="iconify text-indigo-600" data-icon="heroicons:tag" data-width="18"></span><span class="sidebar-text">æ ‡ç­¾ä¸»é¢˜</span></summary>
                        <ul>
                            <li><a href="tags.html">æ ‡ç­¾ç®¡ç†</a></li>
                            <li><a href="tag-edit.html">æ ‡ç­¾ç¼–è¾‘</a></li>
                            <li><a href="topic-groups.html">ä¸»é¢˜ç»„</a></li>
                        </ul>
                    </details>
                </li>
                
                <li><a href="analytics.html"><span class="iconify text-red-600" data-icon="heroicons:chart-bar" data-width="18"></span><span class="sidebar-text">æ•°æ®ç»Ÿè®¡</span></a></li>
                
                <li>
                    <details>
                        <summary><span class="iconify text-gray-600" data-icon="heroicons:cog-6-tooth" data-width="18"></span><span class="sidebar-text">ç³»ç»Ÿè®¾ç½®</span></summary>
                        <ul>
                            <li><a href="settings.html">ç³»ç»Ÿæ¦‚è§ˆ</a></li>
                            <li><a href="admins.html">è´¦æˆ·ç®¡ç†</a></li>
                            <li><a href="permissions.html">æƒé™æ§åˆ¶</a></li>
                            <li><a href="api-config.html">APIé…ç½®</a></li>
                            <li><a href="logs.html">æ—¥å¿—ç‰ˆæœ¬</a></li>
                        </ul>
                    </details>
                </li>
                
                <li>
                    <details>
                        <summary><span class="iconify text-teal-600" data-icon="heroicons:question-mark-circle" data-width="18"></span><span class="sidebar-text">å¸®åŠ©ä¸­å¿ƒ</span></summary>
                        <ul>
                            <li><a href="help.html">å¸®åŠ©æ–‡æ¡£</a></li>
                            <li><a href="upload-guide.html">ä¸Šä¼ æŒ‡å—</a></li>
                            <li><a href="review-standards.html">å®¡æ ¸æ ‡å‡†</a></li>
                            <li><a href="contact.html">è”ç³»å¼€å‘è€…</a></li>
                        </ul>
                    </details>
                </li>
            </ul>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 flex flex-col">
            <!-- Header -->
            <header class="navbar bg-base-100 shadow-sm border-b border-base-300 px-6" style="height: 64px;">
                <div class="navbar-start gap-2">
                    <span class="text-xl font-semibold">å‘ç°é¡µæ¨¡å—ç¼–è¾‘å™¨</span>
                </div>
                
                <div class="navbar-center hidden md:flex">
                    <div class="join">
                        <input type="text" placeholder="æœç´¢æ¨¡å—..." class="input input-bordered input-sm join-item w-80">
                        <button class="btn btn-sm join-item btn-primary">
                            <span class="iconify" data-icon="heroicons:magnifying-glass" data-width="16"></span>
                        </button>
                    </div>
                </div>
                
                <div class="navbar-end gap-3">
                    <div class="indicator">
                        <span class="indicator-item badge badge-accent badge-sm">8</span>
                        <button class="btn btn-ghost btn-circle">
                            <span class="iconify" data-icon="heroicons:bell" data-width="20"></span>
                        </button>
                    </div>
                    
                    <div class="dropdown dropdown-end">
                        <div tabindex="0" role="button" class="btn btn-ghost btn-circle avatar">
                            <div class="w-10 h-10 rounded-full bg-primary flex items-center justify-center">
                                <span class="font-semibold text-white" style="font-size: 16px; line-height: 40px;">ç®¡</span>
                            </div>
                        </div>
                        <ul tabindex="0" class="menu menu-sm dropdown-content mt-3 z-50 p-2 shadow-lg bg-base-100 rounded-box w-52 border border-base-300">
                            <li class="menu-title"><span>ç®¡ç†å‘˜ä¸­å¿ƒ</span></li>
                            <li><a href="admins.html"><span class="iconify" data-icon="heroicons:user" data-width="16"></span>ä¸ªäººèµ„æ–™</a></li>
                            <li><a href="settings.html"><span class="iconify" data-icon="heroicons:cog-6-tooth" data-width="16"></span>ç³»ç»Ÿè®¾ç½®</a></li>
                            <li><a href="logs.html"><span class="iconify" data-icon="heroicons:clock" data-width="16"></span>æ“ä½œæ—¥å¿—</a></li>
                            <div class="divider my-1"></div>
                            <li><a onclick="handleLogout()" class="text-error"><span class="iconify" data-icon="heroicons:arrow-right-on-rectangle" data-width="16"></span>é€€å‡ºç™»å½•</a></li>
                        </ul>
                    </div>
                </div>
            </header>

            <!-- Breadcrumbs -->
            <div class="breadcrumbs text-xs py-2 px-6 bg-base-100 border-b border-base-300">
                <ul>
                    <li><a href="dashboard.html" class="text-base-content/70 hover:text-primary"><span class="iconify" data-icon="heroicons:home" data-width="14"></span>é¦–é¡µ</a></li>
                    <li><a href="curation.html" class="text-base-content/70 hover:text-primary">å†…å®¹ç¼–æ’</a></li>
                    <li><span class="font-medium text-base-content">å‘ç°é¡µæ¨¡å—ç¼–è¾‘å™¨</span></li>
                </ul>
            </div>

            <!-- Content -->
            <div class="flex-1 overflow-y-auto p-6">
                <div class="max-w-7xl mx-auto space-y-8">
                    <!-- Page Header -->
                    <section class="mb-8">
                        <div class="flex items-start justify-between mb-6">
                            <div class="flex-1">
                                <div class="flex items-center gap-4 mb-4">
                                    <button onclick="location.href='curation.html'" class="btn btn-ghost btn-sm gap-2">
                                        <span class="iconify" data-icon="heroicons:arrow-left" data-width="16"></span>
                                        è¿”å›å†…å®¹ç¼–æ’
                                    </button>
                                </div>
                                <h1 class="text-3xl font-bold mb-3">å‘ç°é¡µæ¨¡å—ç¼–è¾‘å™¨</h1>
                                <p class="text-base-content/70 max-w-4xl">ç®¡ç†å‘ç°é¡µçš„é¡¶éƒ¨æ ‡ç­¾å’Œå†…å®¹æ¨¡å—ã€‚å¯è®¾ç½®æ¯æ—¥æ¨èã€æœ€æ–°ä¸Šä¼ ã€æœ€å—æ¬¢è¿è®²é“ã€çƒ­é—¨è®²å‘˜ç­‰æ¿å—ã€‚</p>
                            </div>
                            <div class="flex gap-3">
                                <button onclick="openPreviewMode()" class="btn btn-ghost btn-sm gap-2">
                                    <span class="iconify" data-icon="heroicons:eye" data-width="16"></span>
                                    é¢„è§ˆ
                                </button>
                                <button onclick="openPublishHistory()" class="btn btn-ghost btn-sm gap-2">
                                    <span class="iconify" data-icon="heroicons:clock" data-width="16"></span>
                                    å‘å¸ƒå†å²
                                </button>
                            </div>
                        </div>
                    </section>

                    <!-- 1. Top Filter Tags Management -->
                    <section class="card bg-base-100 shadow-sm border border-base-300">
                        <div class="card-body p-6">
                            <div class="flex items-center justify-between mb-4">
                                <div>
                                    <h2 class="text-xl font-semibold">é¡¶éƒ¨ç­›é€‰æ ‡ç­¾</h2>
                                    <p class="text-sm text-base-content/60 mt-1">æ‹–æ‹½è°ƒæ•´5ä¸ªå›ºå®šæ ‡ç­¾çš„æ˜¾ç¤ºé¡ºåº</p>
                                </div>
                            </div>
                            
                            <div id="tags-container" class="flex flex-wrap gap-2">
                                <div class="badge badge-lg bg-blue-600 text-white border-0 tag-item gap-2 cursor-move" draggable="true">
                                    <span class="iconify" data-icon="heroicons:bars-3" data-width="14"></span>
                                    æ¯æ—¥æ¨è
                                </div>
                                <div class="badge badge-lg bg-gray-700 text-gray-300 border-0 tag-item gap-2 cursor-move" draggable="true">
                                    <span class="iconify" data-icon="heroicons:bars-3" data-width="14"></span>
                                    æœ€æ–°ä¸Šä¼ 
                                </div>
                                <div class="badge badge-lg bg-gray-700 text-gray-300 border-0 tag-item gap-2 cursor-move" draggable="true">
                                    <span class="iconify" data-icon="heroicons:bars-3" data-width="14"></span>
                                    æœ€å—æ¬¢è¿
                                </div>
                                <div class="badge badge-lg bg-gray-700 text-gray-300 border-0 tag-item gap-2 cursor-move" draggable="true">
                                    <span class="iconify" data-icon="heroicons:bars-3" data-width="14"></span>
                                    çƒ­é—¨è®²å‘˜
                                </div>
                                <div class="badge badge-lg bg-gray-700 text-gray-300 border-0 tag-item gap-2 cursor-move" draggable="true">
                                    <span class="iconify" data-icon="heroicons:bars-3" data-width="14"></span>
                                    çƒ­é—¨ä¸»é¢˜
                                </div>
                            </div>
                            
                            <div class="alert alert-info mt-4">
                                <span class="iconify" data-icon="heroicons:information-circle" data-width="20"></span>
                                <span class="text-sm">ç¬¬ä¸€ä¸ªæ ‡ç­¾å°†ä½œä¸ºé»˜è®¤é€‰ä¸­é¡¹ã€‚æ‹–æ‹½æ ‡ç­¾å¯è°ƒæ•´æ˜¾ç¤ºé¡ºåºã€‚</span>
                            </div>
                        </div>
                    </section>

                    <!-- Module Editor Area -->
                    <section class="mb-8">
                        <div class="flex items-center justify-between mb-6">
                            <h2 class="text-xl font-semibold">å†…å®¹æ¨¡å—</h2>
                        </div>
                        
                        <div id="module-list" class="space-y-4">
                            <!-- 1. æ¯æ—¥æ¨èæ¨¡å— -->
                            <div class="card bg-base-100 shadow-sm border border-base-300" data-module-id="daily-recommended">
                                <div class="card-body p-6">
                                    <div class="flex items-center gap-4 mb-4">
                                        <div class="flex items-center gap-3">
                                            <div class="w-8 h-8 bg-blue-100 rounded-lg flex items-center justify-center">
                                                <span class="iconify text-blue-600" data-icon="heroicons:star" data-width="16"></span>
                                            </div>
                                            <div>
                                                <h3 class="font-semibold">æ¯æ—¥æ¨è</h3>
                                                <p class="text-sm text-base-content/60">æ‰‹åŠ¨é€‰æ‹©æ¯æ—¥æ¨èçš„ç²¾é€‰è®²é“</p>
                                            </div>
                                        </div>
                                        <div class="ml-auto">
                                            <button onclick="toggleModuleExpand(this)" class="btn btn-ghost btn-sm btn-circle">
                                                <span class="iconify expand-icon" data-icon="heroicons:chevron-down" data-width="16"></span>
                                            </button>
                                        </div>
                                    </div>
                                    
                                    <div class="module-content">
                                        <div class="mt-6">
                                            <div class="flex items-center justify-between mb-4">
                                                <label class="label-text font-medium">é€‰æ‹©æ¨èè®²é“</label>
                                                <button onclick="openContentSelector('daily-sermons')" class="btn btn-outline btn-sm gap-2">
                                                    <span class="iconify" data-icon="heroicons:plus" data-width="14"></span>
                                                    é€‰æ‹©è®²é“
                                                </button>
                                            </div>
                                            <div class="grid grid-cols-4 md:grid-cols-8 lg:grid-cols-12 gap-2" id="daily-sermons-grid">
                                                <div class="card card-compact bg-base-200">
                                                    <div class="card-body p-2">
                                                        <h4 class="text-sm font-medium line-clamp-2">ç¥çš„æ©å…¸</h4>
                                                        <p class="text-xs text-base-content/60 mt-1">æç‰§å¸ˆ</p>
                                                        <div class="mt-1">
                                                            <button onclick="removeItem(this)" class="btn btn-ghost btn-xs text-error w-full">ç§»é™¤</button>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- 2. æœ€æ–°ä¸Šä¼ æ¨¡å— -->
                            <div class="card bg-base-100 shadow-sm border border-base-300" data-module-id="latest-uploads">
                                <div class="card-body p-6">
                                    <div class="flex items-center gap-4 mb-4">
                                        <div class="flex items-center gap-3">
                                            <div class="w-8 h-8 bg-green-100 rounded-lg flex items-center justify-center">
                                                <span class="iconify text-green-600" data-icon="heroicons:arrow-up-tray" data-width="16"></span>
                                            </div>
                                            <div>
                                                <h3 class="font-semibold">æœ€æ–°ä¸Šä¼ </h3>
                                                <p class="text-sm text-base-content/60">è‡ªåŠ¨è·å–æœ€æ–°æ‰¹å‡†çš„è®²é“ï¼Œæœ€å¤š10æ¡</p>
                                            </div>
                                        </div>
                                        <div class="ml-auto flex gap-2">
                                            <button onclick="autoLoadLatestSermons()" class="btn btn-sm btn-outline gap-2">
                                                <span class="iconify" data-icon="heroicons:arrow-path" data-width="16"></span>
                                                åˆ·æ–°æœ€æ–°
                                            </button>
                                            <button onclick="toggleModuleExpand(this)" class="btn btn-ghost btn-sm btn-circle">
                                                <span class="iconify expand-icon" data-icon="heroicons:chevron-down" data-width="16"></span>
                                            </button>
                                        </div>
                                    </div>
                                    
                                    <div class="module-content">
                                        <div class="alert alert-info mb-4">
                                            <span class="iconify" data-icon="heroicons:information-circle" data-width="20"></span>
                                            <span class="text-sm">æ­¤æ¨¡å—è‡ªåŠ¨å±•ç¤ºæœ€æ–°æ‰¹å‡†çš„è®²é“ï¼ˆæœ€å¤š10æ¡ï¼‰ï¼Œæ‚¨å¯ä»¥ç§»é™¤ä¸æƒ³å±•ç¤ºçš„å†…å®¹ã€‚</span>
                                        </div>
                                        
                                        <!-- è®²é“ç½‘æ ¼ -->
                                        <div class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-5 gap-3 mb-4">
                                            <!-- åŠ¨æ€åŠ è½½ -->
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- 3. æœ€å—æ¬¢è¿æ¨¡å— -->
                            <div class="card bg-base-100 shadow-sm border border-base-300" data-module-id="most-popular">
                                <div class="card-body p-6">
                                    <div class="flex items-center gap-4 mb-4">
                                        <div class="flex items-center gap-3">
                                            <div class="w-8 h-8 bg-red-100 rounded-lg flex items-center justify-center">
                                                <span class="iconify text-red-600" data-icon="heroicons:fire" data-width="16"></span>
                                            </div>
                                            <div>
                                                <h3 class="font-semibold">æœ€å—æ¬¢è¿</h3>
                                                <p class="text-sm text-base-content/60">é€‰æ‹©è®²é“å¹¶æ˜¾ç¤ºæ”¶è—æ¬¡æ•°</p>
                                            </div>
                                        </div>
                                        <div class="ml-auto">
                                            <button onclick="toggleModuleExpand(this)" class="btn btn-ghost btn-sm btn-circle">
                                                <span class="iconify expand-icon" data-icon="heroicons:chevron-down" data-width="16"></span>
                                            </button>
                                        </div>
                                    </div>
                                    
                                    <div class="module-content">
                                        
                                        <div class="mt-6">
                                            <div class="flex items-center justify-between mb-4">
                                                <label class="label-text font-medium">é€‰æ‹©çƒ­é—¨è®²é“</label>
                                                <button onclick="openContentSelector('most-popular')" class="btn btn-outline btn-sm gap-2">
                                                    <span class="iconify" data-icon="heroicons:plus" data-width="14"></span>
                                                    é€‰æ‹©è®²é“
                                                </button>
                                            </div>
                                            <div class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-5 gap-3">
                                                <!-- åŠ¨æ€åŠ è½½ -->
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- 4. çƒ­é—¨è®²å‘˜æ¨¡å— -->
                            <div class="card bg-base-100 shadow-sm border border-base-300" data-module-id="popular-speakers">
                                <div class="card-body p-6">
                                    <div class="flex items-center gap-4 mb-4">
                                        <div class="flex items-center gap-3">
                                            <div class="w-8 h-8 bg-purple-100 rounded-lg flex items-center justify-center">
                                                <span class="iconify text-purple-600" data-icon="heroicons:user-group" data-width="16"></span>
                                            </div>
                                            <div>
                                                <h3 class="font-semibold">çƒ­é—¨è®²å‘˜</h3>
                                                <p class="text-sm text-base-content/60">é€‰æ‹©è®²å‘˜å¹¶æ˜¾ç¤ºè®¢é˜…æ¬¡æ•°</p>
                                            </div>
                                        </div>
                                        <div class="ml-auto">
                                            <button onclick="toggleModuleExpand(this)" class="btn btn-ghost btn-sm btn-circle">
                                                <span class="iconify expand-icon" data-icon="heroicons:chevron-down" data-width="16"></span>
                                            </button>
                                        </div>
                                    </div>
                                    
                                    <div class="module-content">
                                        
                                        <div class="mt-6">
                                            <div class="flex items-center justify-between mb-4">
                                                <label class="label-text font-medium">é€‰æ‹©çƒ­é—¨è®²å‘˜</label>
                                                <button onclick="openContentSelector('popular-speakers')" class="btn btn-outline btn-sm gap-2">
                                                    <span class="iconify" data-icon="heroicons:plus" data-width="14"></span>
                                                    é€‰æ‹©è®²å‘˜
                                                </button>
                                            </div>
                                            <div class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-5 gap-3">
                                                <!-- åŠ¨æ€åŠ è½½ -->
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- 5. çƒ­é—¨ä¸»é¢˜æ¨¡å— -->
                            <div class="card bg-base-100 shadow-sm border border-base-300" data-module-id="popular-topics">
                                <div class="card-body p-6">
                                    <div class="flex items-center gap-4 mb-4">
                                        <div class="flex items-center gap-3">
                                            <div class="w-8 h-8 bg-orange-100 rounded-lg flex items-center justify-center">
                                                <span class="iconify text-orange-600" data-icon="heroicons:tag" data-width="16"></span>
                                            </div>
                                            <div>
                                                <h3 class="font-semibold">çƒ­é—¨ä¸»é¢˜</h3>
                                                <p class="text-sm text-base-content/60">é€‰æ‹©çƒ­é—¨ä¸»é¢˜å¹¶å±•ç¤º</p>
                                            </div>
                                        </div>
                                        <div class="ml-auto">
                                            <button onclick="toggleModuleExpand(this)" class="btn btn-ghost btn-sm btn-circle">
                                                <span class="iconify expand-icon" data-icon="heroicons:chevron-down" data-width="16"></span>
                                            </button>
                                        </div>
                                    </div>
                                    
                                    <div class="module-content">
                                        <div class="mt-6">
                                            <div class="flex items-center justify-between mb-4">
                                                <label class="label-text font-medium">é€‰æ‹©çƒ­é—¨ä¸»é¢˜</label>
                                                <button onclick="openContentSelector('popular-topics')" class="btn btn-outline btn-sm gap-2">
                                                    <span class="iconify" data-icon="heroicons:plus" data-width="14"></span>
                                                    é€‰æ‹©ä¸»é¢˜
                                                </button>
                                            </div>
                                            <div class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-5 gap-3">
                                                <!-- åŠ¨æ€åŠ è½½ -->
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </section>

                    <!-- Action Buttons -->
                    <section class="border-t border-base-300 pt-8">
                        <div class="flex items-center justify-end gap-4">
                            <button onclick="location.href='curation.html'" class="btn btn-ghost">
                                å–æ¶ˆ
                            </button>
                            <button onclick="saveAndPublish()" class="btn btn-primary gap-2">
                                <span class="iconify" data-icon="heroicons:check" data-width="16"></span>
                                ä¿å­˜å¹¶å‘å¸ƒ
                            </button>
                        </div>
                    </section>
                </div>
            </div>
        </main>
    </div>

    <!-- Content Selector Modal -->
    <dialog id="content-selector-modal" class="modal">
        <div class="modal-box w-11/12 max-w-4xl">
            <div class="flex items-center justify-between mb-6">
                <h3 class="font-bold text-lg" id="modal-title">é€‰æ‹©å†…å®¹</h3>
                <form method="dialog">
                    <button class="btn btn-sm btn-circle btn-ghost">
                        <span class="iconify" data-icon="heroicons:x-mark" data-width="16"></span>
                    </button>
                </form>
            </div>
            
            <div class="mb-4">
                <div class="join w-full">
                    <input id="content-search" class="input input-bordered join-item flex-1" placeholder="æœç´¢å†…å®¹...">
                    <button class="btn join-item">
                        <span class="iconify" data-icon="heroicons:magnifying-glass" data-width="16"></span>
                    </button>
                </div>
            </div>
            
            <div id="content-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 max-h-96 overflow-y-auto">
                <!-- Content items will be dynamically loaded here -->
            </div>
            
            <div class="modal-action">
                <form method="dialog" class="flex gap-2">
                    <button class="btn btn-ghost">å–æ¶ˆ</button>
                    <button onclick="confirmContentSelection()" class="btn btn-primary">ç¡®è®¤é€‰æ‹©</button>
                </form>
            </div>
        </div>
    </dialog>

    <script>
        // Global functions
        function handleLogout() {
            localStorage.removeItem('admin_token');
            localStorage.removeItem('admin_username');
            window.location.href = 'login.html';
        }

        // Module expansion/collapse
        function toggleModuleExpand(button) {
            const card = button.closest('.card');
            const content = card.querySelector('.module-content');
            const icon = button.querySelector('.expand-icon');
            
            if (content.classList.contains('collapsed')) {
                content.classList.remove('collapsed');
                icon.classList.remove('rotated');
            } else {
                content.classList.add('collapsed');
                icon.classList.add('rotated');
            }
        }

        // Tag drag and drop (5 fixed tags, no add/remove)
        function initTagDragDrop() {
            const container = document.getElementById('tags-container');
            let draggedElement = null;
            
            const tags = container.querySelectorAll('.tag-item');
            tags.forEach(tag => {
                tag.addEventListener('dragstart', function(e) {
                    draggedElement = this;
                    this.style.opacity = '0.5';
                });
                
                tag.addEventListener('dragend', function(e) {
                    this.style.opacity = '1';
                });
                
                tag.addEventListener('dragover', function(e) {
                    e.preventDefault();
                    if (this !== draggedElement) {
                        const rect = this.getBoundingClientRect();
                        const midpoint = rect.left + rect.width / 2;
                        
                        if (e.clientX < midpoint) {
                            container.insertBefore(draggedElement, this);
                        } else {
                            container.insertBefore(draggedElement, this.nextSibling);
                        }
                    }
                });
            });
        }
        
        // åŠ è½½å‘ç°é¡µé…ç½®
        async function loadDiscoverConfig() {
            try {
                console.log('ğŸ”„ åŠ è½½å‘ç°é¡µé…ç½®...');
                const response = await fetch('http://localhost:3000/v1/curation/discover-config');
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                const result = await response.json();
                const config = result.data.config;
                console.log('âœ… åŠ è½½æˆåŠŸ:', config);
                
                // æ¸²æŸ“æ ‡ç­¾é¡ºåº
                renderFilterTags(config.filterTags);
                
                // æ¸²æŸ“æ¯ä¸ªæ¨¡å—çš„è®²é“
                await renderModuleSermons(config.filterTags);
                
                // ç‰¹åˆ«å¤„ç†ï¼šä¸º"æœ€æ–°ä¸Šä¼ "æ¨¡å—è‡ªåŠ¨åŠ è½½æœ€æ–°è®²é“
                const latestUploadsTag = config.filterTags.find(tag => tag.id === 'latest-uploads');
                if (latestUploadsTag && (!latestUploadsTag.sermonIds || latestUploadsTag.sermonIds.length === 0)) {
                    console.log('ğŸ”„ "æœ€æ–°ä¸Šä¼ "æ¨¡å—æ— å†…å®¹ï¼Œè‡ªåŠ¨åŠ è½½æœ€æ–°è®²é“...');
                    await autoLoadLatestSermons();
                }
                
            } catch (error) {
                console.error('âŒ åŠ è½½é…ç½®å¤±è´¥:', error);
                showNotification('åŠ è½½é…ç½®å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤é…ç½®', 'warning');
            }
        }
        
        // æ¸²æŸ“ç­›é€‰æ ‡ç­¾
        function renderFilterTags(filterTags) {
            const container = document.getElementById('tags-container');
            container.innerHTML = '';
            
            filterTags.forEach((tag, index) => {
                const tagEl = document.createElement('div');
                tagEl.className = `badge badge-lg ${index === 0 ? 'bg-blue-600 text-white' : 'bg-gray-700 text-gray-300'} border-0 tag-item gap-2 cursor-move`;
                tagEl.draggable = true;
                tagEl.innerHTML = `
                    <span class="iconify" data-icon="heroicons:bars-3" data-width="14"></span>
                    ${tag.title}
                `;
                container.appendChild(tagEl);
            });
            
            // é‡æ–°åˆå§‹åŒ–æ‹–æ‹½
            initTagDragDrop();
        }
        
        // æ¸²æŸ“æ¨¡å—è®²é“/è®²å‘˜/ä¸»é¢˜
        async function renderModuleSermons(filterTags) {
            const tagMapping = {
                'daily-recommended': 'daily-recommended',
                'latest-uploads': 'latest-uploads',
                'most-popular': 'most-popular',
                'popular-speakers': 'popular-speakers',
                'popular-topics': 'popular-topics'
            };
            
            for (const tag of filterTags) {
                const moduleId = tagMapping[tag.id];
                const grid = document.querySelector(`[data-module-id="${moduleId}"] .grid`);
                if (!grid) continue;
                
                grid.innerHTML = ''; // æ¸…ç©º
                
                // ç‰¹æ®Šå¤„ç†ï¼šçƒ­é—¨è®²å‘˜æ¨¡å—ä½¿ç”¨ speakerIds
                if (moduleId === 'popular-speakers') {
                    const speakerIds = tag.speakerIds || tag.sermonIds || []; // å…¼å®¹æ—§æ•°æ®
                    if (speakerIds.length === 0) continue;
                    
                    for (const speakerId of speakerIds) {
                        try {
                            const response = await fetch(`http://localhost:3000/v1/speakers/${speakerId}`);
                            if (!response.ok) continue;
                            
                            const result = await response.json();
                            const speaker = result.data || result;
                            
                            const card = document.createElement('div');
                            card.className = 'card card-compact bg-base-200';
                            card.setAttribute('data-speaker-id', speaker.id);
                            
                            card.innerHTML = `
                                <div class="card-body p-2">
                                    <h4 class="text-sm font-medium text-center line-clamp-1">${speaker.name}</h4>
                                    <p class="text-xs text-base-content/60 text-center mt-1">${speaker.church || 'æœªçŸ¥æ•™ä¼š'}</p>
                                    <div class="badge badge-sm badge-secondary mt-1 w-full">${speaker.follower_count || 0} è®¢é˜…</div>
                                    <div class="mt-1">
                                        <button onclick="removeItem(this)" class="btn btn-ghost btn-xs text-error w-full">ç§»é™¤</button>
                                    </div>
                                </div>
                            `;
                            grid.appendChild(card);
                        } catch (error) {
                            console.error(`åŠ è½½è®²å‘˜ ${speakerId} å¤±è´¥:`, error);
                        }
                    }
                } else if (moduleId === 'popular-topics') {
                    // çƒ­é—¨ä¸»é¢˜æ¨¡å—ï¼šåŠ è½½ä¸»é¢˜
                    const topicIds = tag.topicIds || tag.sermonIds || [];
                    if (topicIds.length === 0) continue;
                    
                    for (const topicId of topicIds) {
                        try {
                            const response = await fetch(`http://localhost:3000/v1/topics/${topicId}`);
                            if (!response.ok) continue;
                            
                            const result = await response.json();
                            const topic = result.data || result;
                            
                            const card = document.createElement('div');
                            card.className = 'card card-compact bg-base-200';
                            card.setAttribute('data-topic-id', topic.id);
                            
                            card.innerHTML = `
                                <div class="card-body p-2">
                                    <h4 class="text-sm font-medium line-clamp-2">${topic.name}</h4>
                                    <p class="text-xs text-base-content/60 mt-1">${topic.sermon_count || 0} ç¯‡è®²é“</p>
                                    <div class="mt-1">
                                        <button onclick="removeItem(this)" class="btn btn-ghost btn-xs text-error w-full">ç§»é™¤</button>
                                    </div>
                                </div>
                            `;
                            grid.appendChild(card);
                        } catch (error) {
                            console.error(`åŠ è½½ä¸»é¢˜ ${topicId} å¤±è´¥:`, error);
                        }
                    }
                } else {
                    // å…¶ä»–æ¨¡å—ï¼šåŠ è½½è®²é“
                    const sermonIds = tag.sermonIds || [];
                    if (sermonIds.length === 0) continue;
                    
                    for (const sermonId of sermonIds) {
                        try {
                            const response = await fetch(`http://localhost:3000/v1/sermons/${sermonId}`);
                            if (!response.ok) continue;
                            
                            const result = await response.json();
                            const sermon = result.data || result;
                            
                            const card = document.createElement('div');
                            card.className = 'card card-compact bg-base-200';
                            card.setAttribute('data-sermon-id', sermon.id);
                            
                            // ä¸º"æœ€å—æ¬¢è¿"æ¨¡å—æ˜¾ç¤ºæ”¶è—æ¬¡æ•°
                            const favoriteCountBadge = moduleId === 'most-popular' 
                                ? `<div class="badge badge-sm badge-error mt-1">${sermon.favorite_count || 0} æ”¶è—</div>`
                                : '';
                            
                            card.innerHTML = `
                                <div class="card-body p-2">
                                    <h4 class="text-sm font-medium line-clamp-2">${sermon.title}</h4>
                                    <p class="text-xs text-base-content/60 mt-1">${sermon.speaker?.name || 'æœªçŸ¥è®²å‘˜'}</p>
                                    ${favoriteCountBadge}
                                    <div class="mt-1">
                                        <button onclick="removeItem(this)" class="btn btn-ghost btn-xs text-error w-full">ç§»é™¤</button>
                                    </div>
                                </div>
                            `;
                            grid.appendChild(card);
                        } catch (error) {
                            console.error(`åŠ è½½è®²é“ ${sermonId} å¤±è´¥:`, error);
                        }
                    }
                }
            }
        }
        
        // è‡ªåŠ¨åŠ è½½æœ€æ–°ä¸Šä¼ çš„è®²é“ï¼ˆæœ€å¤š10æ¡ï¼‰
        async function autoLoadLatestSermons() {
            try {
                console.log('ğŸ”„ è‡ªåŠ¨åŠ è½½æœ€æ–°æ‰¹å‡†çš„è®²é“...');
                
                // è·å–æœ€æ–°å·²å‘å¸ƒçš„è®²é“ï¼ŒæŒ‰æ›´æ–°æ—¶é—´æ’åºï¼Œé™åˆ¶10æ¡
                const response = await fetch('http://localhost:3000/v1/sermons?status=published&_sort=updated_at&_order=desc&_limit=10');
                if (!response.ok) throw new Error('è·å–è®²é“å¤±è´¥');
                
                const result = await response.json();
                const sermons = result.data || result;
                
                console.log(`âœ… è·å–åˆ° ${sermons.length} æ¡æœ€æ–°è®²é“`);
                
                // æ¸²æŸ“åˆ° latest-uploads æ¨¡å—
                const grid = document.querySelector('[data-module-id="latest-uploads"] .grid');
                if (!grid) {
                    console.error('âŒ æ‰¾ä¸åˆ°æœ€æ–°ä¸Šä¼ æ¨¡å—çš„ grid');
                    return;
                }
                
                grid.innerHTML = ''; // æ¸…ç©ºç°æœ‰å†…å®¹
                
                // æ¸²æŸ“æ¯ä¸ªè®²é“å¡ç‰‡
                sermons.forEach(sermon => {
                    const card = document.createElement('div');
                    card.className = 'card card-compact bg-base-200';
                    card.setAttribute('data-sermon-id', sermon.id);
                    card.innerHTML = `
                        <div class="card-body p-2">
                            <h4 class="text-sm font-medium line-clamp-2">${sermon.title}</h4>
                            <p class="text-xs text-base-content/60 mt-1">${sermon.speaker?.name || 'æœªçŸ¥è®²å‘˜'}</p>
                            <div class="mt-1">
                                <button onclick="removeItem(this)" class="btn btn-ghost btn-xs text-error w-full">ç§»é™¤</button>
                            </div>
                        </div>
                    `;
                    grid.appendChild(card);
                });
                
                showNotification('success', `å·²åŠ è½½ ${sermons.length} æ¡æœ€æ–°è®²é“`);
            } catch (error) {
                console.error('âŒ è‡ªåŠ¨åŠ è½½æœ€æ–°è®²é“å¤±è´¥:', error);
                showNotification('error', 'åŠ è½½å¤±è´¥: ' + error.message);
            }
        }
        
        // Initialize tag drag drop on load
        document.addEventListener('DOMContentLoaded', function() {
            initTagDragDrop();
            loadDiscoverConfig(); // åŠ è½½é…ç½®
        });

        // Module drag and drop
        (function initializeDragAndDrop() {
            const moduleList = document.getElementById('module-list');
            if (!moduleList) return;
            
            let draggedElement = null;
            
            const modules = moduleList.querySelectorAll('.card');
            modules.forEach(module => {
                const dragHandle = module.querySelector('.drag-handle');
                if (dragHandle) {
                    dragHandle.addEventListener('mousedown', function(e) {
                        module.draggable = true;
                    });
                    
                    module.addEventListener('dragstart', function(e) {
                        draggedElement = this;
                        this.classList.add('module-dragging');
                        e.dataTransfer.effectAllowed = 'move';
                    });
                    
                    module.addEventListener('dragend', function(e) {
                        this.classList.remove('module-dragging');
                        this.draggable = false;
                        
                        const dropZones = moduleList.querySelectorAll('.drop-zone');
                        dropZones.forEach(zone => zone.classList.remove('drop-zone'));
                    });
                    
                    module.addEventListener('dragover', function(e) {
                        e.preventDefault();
                        e.dataTransfer.dropEffect = 'move';
                        
                        if (this !== draggedElement) {
                            this.classList.add('drop-zone');
                        }
                    });
                    
                    module.addEventListener('dragleave', function(e) {
                        this.classList.remove('drop-zone');
                    });
                    
                    module.addEventListener('drop', function(e) {
                        e.preventDefault();
                        this.classList.remove('drop-zone');
                        
                        if (this !== draggedElement) {
                            const rect = this.getBoundingClientRect();
                            const midpoint = rect.top + rect.height / 2;
                            
                            if (e.clientY < midpoint) {
                                moduleList.insertBefore(draggedElement, this);
                            } else {
                                moduleList.insertBefore(draggedElement, this.nextSibling);
                            }
                            
                            showNotification('æ¨¡å—é¡ºåºå·²æ›´æ–°', 'success');
                        }
                    });
                }
            });
        })();

        // Content selector
        let currentSelectorType = '';
        let selectedItems = [];
        let targetGrid = null;
        
        function openContentSelector(type) {
            currentSelectorType = type;
            selectedItems = [];
            
            // ä½¿ç”¨ data-module-id æ¥æŸ¥æ‰¾å¯¹åº”çš„ grid
            const moduleMap = {
                'daily-recommended': 'daily-recommended',
                'most-popular': 'most-popular',
                'popular-speakers': 'popular-speakers',
                'popular-topics': 'popular-topics'
            };
            
            const moduleId = moduleMap[type];
            targetGrid = type; // ä¿å­˜ç±»å‹ç”¨äºåç»­å¤„ç†
            
            // è·å–å·²å­˜åœ¨çš„ ID åˆ—è¡¨
            const grid = document.querySelector(`[data-module-id="${moduleId}"] .grid`);
            const existingIds = new Set();
            if (grid) {
                const existingCards = grid.querySelectorAll('.card[data-sermon-id], .card[data-speaker-id], .card[data-topic-id]');
                existingCards.forEach(card => {
                    const itemId = card.dataset.sermonId || card.dataset.speakerId || card.dataset.topicId;
                    if (itemId) existingIds.add(itemId);
                });
            }
            window.existingIdsInCurrentGrid = existingIds;
            
            console.log('ğŸ” æ‰“å¼€å†…å®¹é€‰æ‹©å™¨:', type, 'å·²æœ‰é¡¹ç›®:', existingIds);
            
            const modal = document.getElementById('content-selector-modal');
            const title = document.getElementById('modal-title');
            const contentGrid = document.getElementById('content-grid');
            
            const titles = {
                'daily-recommended': 'é€‰æ‹©æ¯æ—¥æ¨èè®²é“',
                'most-popular': 'é€‰æ‹©çƒ­é—¨è®²é“',
                'popular-speakers': 'é€‰æ‹©çƒ­é—¨è®²å‘˜',
                'popular-topics': 'é€‰æ‹©çƒ­é—¨ä¸»é¢˜'
            };
            title.textContent = titles[type] || 'é€‰æ‹©å†…å®¹';
            
            loadContentItems(type, contentGrid);
            modal.showModal();
        }
        
        async function loadContentItems(type, container) {
            container.innerHTML = '<div class="col-span-3 flex justify-center items-center h-48"><span class="loading loading-spinner loading-lg text-primary"></span></div>';
            
            try {
                let items = [];
                
                const isSpeakersType = type === 'popular-speakers';
                const isTopicsType = type === 'popular-topics';
                
                if (isSpeakersType) {
                    // ä» API åŠ è½½è®²å‘˜åˆ—è¡¨ï¼ˆåŒ…å«å®Œæ•´æ•°æ®ï¼‰
                    const response = await fetch('http://localhost:3000/v1/speakers?_limit=50');
                    const result = await response.json();
                    const speakers = result.data || result;
                    items = speakers.map(speaker => ({
                        id: speaker.id,
                        name: speaker.name,
                        church: speaker.church || 'æœªçŸ¥æ•™ä¼š',
                        follower_count: speaker.follower_count || 0
                    }));
                } else if (isTopicsType) {
                    // ä» API åŠ è½½ä¸»é¢˜åˆ—è¡¨ï¼ˆåŒ…å«å®Œæ•´æ•°æ®ï¼‰
                    const response = await fetch('http://localhost:3000/v1/topics?_limit=50');
                    const result = await response.json();
                    const topics = result.data || result;
                    items = topics.map(topic => ({
                        id: topic.id,
                        name: topic.name,
                        description: topic.description || '',
                        sermon_count: topic.sermon_count || 0
                    }));
                } else {
                    // ä» API åŠ è½½è®²é“åˆ—è¡¨ï¼ˆåŒ…å«å®Œæ•´æ•°æ®ï¼‰
                    const response = await fetch('http://localhost:3000/v1/sermons?_limit=50');
                    const result = await response.json();
                    const sermons = result.data || result;
                    items = sermons.map(sermon => ({
                        id: sermon.id,
                        title: sermon.title,
                        speaker: sermon.speaker?.name || 'æœªçŸ¥è®²å‘˜',
                        favorite_count: sermon.favorite_count || 0
                    }));
                }
                
                renderContentItems(items, type, container);
            } catch (error) {
                console.error('åŠ è½½å†…å®¹å¤±è´¥:', error);
                container.innerHTML = '<div class="col-span-3 text-center text-error p-8">åŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é‡è¯•</div>';
            }
        }
        
        function renderContentItems(items, type, container) {
            container.innerHTML = '';
            
            const isSpeakersType = type === 'popular-speakers';
            const isTopicsType = type === 'popular-topics';
            const showFavorites = type === 'most-popular'; // åªæœ‰"æœ€å—æ¬¢è¿"æ˜¾ç¤ºæ”¶è—æ•°
            const existingIds = window.existingIdsInCurrentGrid || new Set();
            
            items.forEach(item => {
                const isExisting = existingIds.has(item.id);
                
                const div = document.createElement('div');
                div.className = 'content-item card card-compact bg-base-100 border border-base-300';
                
                if (isExisting) {
                    div.className += ' opacity-40 cursor-not-allowed';
                } else {
                    div.className += ' cursor-pointer';
                }
                
                div.dataset.itemId = item.id;
                div.dataset.itemData = JSON.stringify(item);
                
                let content = '';
                if (isSpeakersType) {
                    // è®²å‘˜ç±»å‹ - æ˜¾ç¤ºè®¢é˜…æ¬¡æ•°
                    content = `
                        <div class="card-body">
                            <h4 class="card-title text-sm text-center">${item.name}</h4>
                            <p class="text-xs text-base-content/60 text-center">${item.church}</p>
                            <div class="badge badge-sm badge-secondary mt-1 w-full">${item.follower_count} è®¢é˜…</div>
                            ${isExisting ? '<p class="text-xs text-warning text-center mt-1">å·²æ·»åŠ </p>' : ''}
                        </div>
                    `;
                } else if (isTopicsType) {
                    // ä¸»é¢˜ç±»å‹ - æ˜¾ç¤ºè®²é“æ•°é‡
                    content = `
                        <div class="card-body">
                            <h4 class="card-title text-sm">${item.name}</h4>
                            <p class="text-xs text-base-content/60">${item.sermon_count} ç¯‡è®²é“</p>
                            ${isExisting ? '<p class="text-xs text-warning mt-1">å·²æ·»åŠ </p>' : ''}
                        </div>
                    `;
                } else {
                    // è®²é“ç±»å‹
                    const favoriteBadge = showFavorites 
                        ? `<div class="badge badge-sm badge-error mt-1">${item.favorite_count} æ”¶è—</div>`
                        : '';
                    
                    content = `
                        <div class="card-body">
                            <h4 class="card-title text-sm">${item.title}</h4>
                            <p class="text-xs text-base-content/60">${item.speaker}</p>
                            ${favoriteBadge}
                            ${isExisting ? '<p class="text-xs text-warning mt-1">å·²æ·»åŠ </p>' : ''}
                        </div>
                    `;
                }
                
                div.innerHTML = content;
                
                // åªæœ‰æœªæ·»åŠ çš„é¡¹ç›®æ‰å¯ä»¥ç‚¹å‡»
                if (!isExisting) {
                    div.addEventListener('click', function() {
                        this.classList.toggle('selected');
                        const itemId = this.dataset.itemId; // ä¿æŒå­—ç¬¦ä¸²æ ¼å¼
                        const itemData = JSON.parse(this.dataset.itemData);
                        
                        if (this.classList.contains('selected')) {
                            if (!selectedItems.find(i => i.id === itemId)) {
                                selectedItems.push(itemData);
                            }
                        } else {
                            selectedItems = selectedItems.filter(i => i.id !== itemId);
                        }
                    });
                }
                
                container.appendChild(div);
            });
        }
        
        function confirmContentSelection() {
            if (selectedItems.length === 0) {
                showNotification('è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªé¡¹ç›®', 'warning');
                return;
            }
            
            // ä½¿ç”¨ data-module-id æ¥æŸ¥æ‰¾ç›®æ ‡ grid
            const moduleMap = {
                'daily-recommended': 'daily-recommended',
                'most-popular': 'most-popular',
                'popular-speakers': 'popular-speakers',
                'popular-topics': 'popular-topics'
            };
            
            const moduleId = moduleMap[currentSelectorType];
            const grid = document.querySelector(`[data-module-id="${moduleId}"] .grid`);
            
            if (!grid) {
                console.error('âŒ æ‰¾ä¸åˆ°ç›®æ ‡ grid:', currentSelectorType, moduleId);
                showNotification('ç›®æ ‡åŒºåŸŸæœªæ‰¾åˆ°', 'error');
                return;
            }
            
            const isSpeakersType = currentSelectorType === 'popular-speakers';
            const isTopicsType = currentSelectorType === 'popular-topics';
            const showFavorites = currentSelectorType === 'most-popular';
            
            // è·å–å·²å­˜åœ¨çš„ IDï¼Œé¿å…é‡å¤æ·»åŠ 
            const existingIds = new Set();
            const existingCards = grid.querySelectorAll('.card[data-sermon-id], .card[data-speaker-id], .card[data-topic-id]');
            existingCards.forEach(card => {
                if (card.dataset.sermonId) existingIds.add(card.dataset.sermonId);
                if (card.dataset.speakerId) existingIds.add(card.dataset.speakerId);
                if (card.dataset.topicId) existingIds.add(card.dataset.topicId);
            });
            
            let addedCount = 0;
            let skippedCount = 0;
            
            selectedItems.forEach(item => {
                // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨
                if (existingIds.has(item.id)) {
                    skippedCount++;
                    console.log('â­ï¸ è·³è¿‡é‡å¤é¡¹:', item.id);
                    return;
                }
                
                const newCard = document.createElement('div');
                newCard.className = 'card card-compact bg-base-200';
                
                // è®¾ç½® data å±æ€§ï¼ˆé‡è¦ï¼ï¼‰
                if (isSpeakersType) {
                    newCard.setAttribute('data-speaker-id', item.id);
                } else if (isTopicsType) {
                    newCard.setAttribute('data-topic-id', item.id);
                } else {
                    newCard.setAttribute('data-sermon-id', item.id);
                }
                
                let cardContent = '';
                if (isSpeakersType) {
                    cardContent = `
                        <div class="card-body p-2">
                            <h4 class="text-sm font-medium text-center line-clamp-1">${item.name}</h4>
                            <p class="text-xs text-base-content/60 text-center mt-1">${item.church}</p>
                            <div class="badge badge-sm badge-secondary mt-1 w-full">${item.follower_count || 0} è®¢é˜…</div>
                            <div class="mt-1">
                                <button onclick="removeItem(this)" class="btn btn-ghost btn-xs text-error w-full">ç§»é™¤</button>
                            </div>
                        </div>
                    `;
                } else if (isTopicsType) {
                    cardContent = `
                        <div class="card-body p-2">
                            <h4 class="text-sm font-medium line-clamp-2">${item.name}</h4>
                            <p class="text-xs text-base-content/60 mt-1">${item.sermon_count || 0} ç¯‡è®²é“</p>
                            <div class="mt-1">
                                <button onclick="removeItem(this)" class="btn btn-ghost btn-xs text-error w-full">ç§»é™¤</button>
                            </div>
                        </div>
                    `;
                } else {
                    // è®²é“ç±»å‹ - ä¸º"æœ€å—æ¬¢è¿"æ˜¾ç¤ºæ”¶è—æ¬¡æ•°
                    const favoriteBadge = showFavorites 
                        ? `<div class="badge badge-sm badge-error mt-1">${item.favorite_count || 0} æ”¶è—</div>`
                        : '';
                    
                    cardContent = `
                        <div class="card-body p-2">
                            <h4 class="text-sm font-medium line-clamp-2">${item.title}</h4>
                            <p class="text-xs text-base-content/60 mt-1">${item.speaker}</p>
                            ${favoriteBadge}
                            <div class="mt-1">
                                <button onclick="removeItem(this)" class="btn btn-ghost btn-xs text-error w-full">ç§»é™¤</button>
                            </div>
                        </div>
                    `;
                }
                
                newCard.innerHTML = cardContent;
                grid.appendChild(newCard);
                addedCount++;
                console.log('âœ… æ·»åŠ é¡¹ç›®:', item.id, item.title || item.name);
            });
            
            // æ˜¾ç¤ºæ·»åŠ ç»“æœ
            if (addedCount > 0 && skippedCount > 0) {
                showNotification(`å·²æ·»åŠ  ${addedCount} ä¸ªé¡¹ç›®ï¼Œè·³è¿‡ ${skippedCount} ä¸ªé‡å¤é¡¹ç›®`, 'success');
            } else if (addedCount > 0) {
                showNotification(`å·²æ·»åŠ  ${addedCount} ä¸ªé¡¹ç›®`, 'success');
            } else if (skippedCount > 0) {
                showNotification(`æ‰€é€‰é¡¹ç›®å‡å·²å­˜åœ¨`, 'warning');
            }
            
            const modal = document.getElementById('content-selector-modal');
            modal.close();
            selectedItems = [];
        }

        // Remove item from grid
        function removeItem(button) {
            button.closest('.card').remove();
            showNotification('å·²ç§»é™¤', 'success');
        }
        
        // Utility functions
        function openPreviewMode() {
            showNotification('é¢„è§ˆæ¨¡å¼åŠŸèƒ½å¼€å‘ä¸­', 'info');
        }
        
        function openPublishHistory() {
            showNotification('å‘å¸ƒå†å²åŠŸèƒ½å¼€å‘ä¸­', 'info');
        }
        
        async function saveAndPublish() {
            const button = event.target;
            const originalHTML = button.innerHTML;
            button.innerHTML = '<span class="loading loading-spinner loading-sm"></span> ä¿å­˜ä¸­...';
            button.disabled = true;
            
            try {
                // æ”¶é›†é…ç½®æ•°æ®
                const configData = collectDiscoverConfig();
                console.log('ğŸ“¦ å‡†å¤‡ä¿å­˜é…ç½®:', configData);
                
                // ä¿å­˜åˆ° API
                const response = await fetch('http://localhost:3000/v1/curation/discover-config', {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(configData)
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const result = await response.json();
                console.log('âœ… ä¿å­˜æˆåŠŸ:', result);
                
                button.innerHTML = originalHTML;
                button.disabled = false;
                showNotification('å‘ç°é¡µé…ç½®å·²ä¿å­˜å¹¶å‘å¸ƒåˆ° App', 'success');
                
                setTimeout(() => {
                    location.href = 'curation.html';
                }, 1500);
                
            } catch (error) {
                console.error('âŒ ä¿å­˜å¤±è´¥:', error);
                button.innerHTML = originalHTML;
                button.disabled = false;
                showNotification(`ä¿å­˜å¤±è´¥: ${error.message}`, 'error');
            }
        }
        
        // æ”¶é›†å‘ç°é¡µé…ç½®
        function collectDiscoverConfig() {
            // 1. æ”¶é›†æ ‡ç­¾é¡ºåº
            const filterTags = [];
            const tagContainer = document.getElementById('tags-container');
            const tagElements = tagContainer.querySelectorAll('.tag-item');
            
            const tagMapping = {
                'æ¯æ—¥æ¨è': { id: 'daily-recommended', moduleId: 'daily-recommended' },
                'æœ€æ–°ä¸Šä¼ ': { id: 'latest-uploads', moduleId: 'latest-uploads' },
                'æœ€å—æ¬¢è¿': { id: 'most-popular', moduleId: 'most-popular' },
                'çƒ­é—¨è®²å‘˜': { id: 'popular-speakers', moduleId: 'popular-speakers' },
                'çƒ­é—¨ä¸»é¢˜': { id: 'popular-topics', moduleId: 'popular-topics' }
            };
            
            tagElements.forEach(tagEl => {
                const title = tagEl.textContent.trim();
                const mapping = tagMapping[title];
                if (mapping) {
                    const moduleGrid = document.querySelector(`[data-module-id="${mapping.moduleId}"] .grid`);
                    
                    // ç‰¹æ®Šå¤„ç†ï¼šçƒ­é—¨è®²å‘˜æ¨¡å—æ”¶é›† speakerIds
                    if (mapping.id === 'popular-speakers') {
                        const speakerIds = [];
                        if (moduleGrid) {
                            const speakerCards = moduleGrid.querySelectorAll('.card[data-speaker-id]');
                            speakerCards.forEach(card => {
                                const speakerId = card.dataset.speakerId;
                                if (speakerId) speakerIds.push(speakerId);
                            });
                        }
                        
                        filterTags.push({
                            id: mapping.id,
                            title: title,
                            speakerIds: speakerIds,
                            sermonIds: [] // ä¿ç•™ç©ºçš„ sermonIds ä»¥å…¼å®¹
                        });
                    } else if (mapping.id === 'popular-topics') {
                        // ç‰¹æ®Šå¤„ç†ï¼šçƒ­é—¨ä¸»é¢˜æ¨¡å—æ”¶é›† topicIds
                        const topicIds = [];
                        if (moduleGrid) {
                            const topicCards = moduleGrid.querySelectorAll('.card[data-topic-id]');
                            topicCards.forEach(card => {
                                const topicId = card.dataset.topicId;
                                if (topicId) topicIds.push(topicId);
                            });
                        }
                        
                        filterTags.push({
                            id: mapping.id,
                            title: title,
                            topicIds: topicIds,
                            sermonIds: [] // ä¿ç•™ç©ºçš„ sermonIds ä»¥å…¼å®¹
                        });
                    } else {
                        // å…¶ä»–æ¨¡å—ï¼šæ”¶é›†è®²é“
                        const sermonIds = [];
                        if (moduleGrid) {
                            const sermonCards = moduleGrid.querySelectorAll('.card[data-sermon-id]');
                            sermonCards.forEach(card => {
                                const sermonId = card.dataset.sermonId;
                                if (sermonId) sermonIds.push(sermonId);
                            });
                        }
                        
                        filterTags.push({
                            id: mapping.id,
                            title: title,
                            sermonIds: sermonIds
                        });
                    }
                }
            });
            
            console.log('âœ… æ”¶é›†åˆ°æ ‡ç­¾é…ç½®:', filterTags);
            
            return {
                config: {
                    filterTags: filterTags
                },
                updated_at: new Date().toISOString()
            };
        }
        
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `alert alert-${type} fixed top-4 right-4 w-96 z-50 shadow-lg`;
            notification.innerHTML = `
                <div class="flex items-center gap-2">
                    <span class="iconify" data-icon="heroicons:information-circle" data-width="20"></span>
                    <span>${message}</span>
                </div>
            `;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.opacity = '0';
                setTimeout(() => notification.remove(), 150);
            }, 3000);
        }

        // Initialize page when DOM is ready
        if (typeof DiscoverEditorPage !== 'undefined') {
            document.addEventListener('DOMContentLoaded', () => {
                DiscoverEditorPage.init();
            });
        }
    </script>
</body>
</html>

