<!DOCTYPE html>
<html lang="zh-CN" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>è®²é“è¯¦æƒ…ä¸å®¡æ ¸ - å¬é“åå°ç®¡ç†ç³»ç»Ÿ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/daisyui@4.4.19/dist/full.min.css" rel="stylesheet" type="text/css" />
    <script src="https://code.iconify.design/3/3.1.1/iconify.min.js"></script>
    
    <!-- API Client -->
    <script src="js/api-config.js?v=20251120"></script>
    
    <style>
        body {
            font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        }

        /* Status indicators */
        .status-indicator {
            display: inline-flex;
            align-items: center;
            gap: 0.375rem;
            padding: 0.25rem 0.75rem;
            border-radius: 0.375rem;
            font-size: 0.8rem;
            font-weight: 600;
            letter-spacing: 0.025em;
        }

        .status-pending {
            background-color: rgba(251, 191, 36, 0.1);
            color: rgba(180, 83, 9, 1);
        }

        .status-published,
        .status-approved {
            background-color: rgba(16, 185, 129, 0.1);
            color: rgba(5, 150, 105, 1);
        }

        .status-rejected,
        .status-revision {
            background-color: rgba(239, 68, 68, 0.1);
            color: rgba(185, 28, 28, 1);
        }

        /* Card styles */
        .card-minimal {
            border: 1px solid #E5E7EB;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
        }

        .card-minimal:hover {
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        }

        /* Sidebar styles */
        .sidebar-wrapper {
            width: 220px;
            flex-shrink: 0;
        }

        .sidebar-wrapper .menu li > a {
            padding: 0.6rem 0.8rem;
            font-size: 0.9rem;
        }

        .sidebar-wrapper .menu li > a .iconify {
            width: 18px;
            height: 18px;
        }

        /* Header styles */
        .header-height {
            height: 64px;
        }

        /* Audio player styles */
        .audio-progress-bar {
            background: #E5E7EB;
            height: 8px;
            border-radius: 4px;
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }

        .audio-progress-fill {
            background: #3B82F6;
            height: 100%;
            border-radius: 4px;
            transition: width 0.1s ease;
        }

        /* Transition utilities */
        .transition-smooth {
            transition: all 0.15s ease-in-out;
        }
    </style>
</head>
<body class="bg-base-200">
    <!-- Header -->
    <header class="navbar bg-base-100 shadow-sm border-b border-base-300 px-6" style="height: 64px;">
        <div class="navbar-start gap-2">
            <img src="https://spark-builder.s3.cn-north-1.amazonaws.com.cn/image/2025/10/22/523fba63-3739-42ea-876b-c02f6da135ee.png" alt="Logo" class="w-10 h-10 rounded-lg">
            <span class="text-xl font-semibold hidden lg:inline">å¬é“åå°</span>
        </div>
        
        <div class="navbar-center hidden md:flex">
            <div class="join">
                <input type="text" placeholder="æœç´¢è®²é“ã€è®²å‘˜..." class="input input-bordered input-sm join-item w-80">
                <button class="btn btn-sm join-item btn-primary">
                    <span class="iconify" data-icon="heroicons:magnifying-glass" data-width="16"></span>
                </button>
            </div>
        </div>
        
        <div class="navbar-end gap-3">
            <div class="indicator">
                <span class="indicator-item badge badge-accent badge-sm">8</span>
                <button class="btn btn-ghost btn-circle">
                    <span class="iconify" data-icon="heroicons:bell" data-width="20"></span>
                </button>
            </div>
            
            <div class="dropdown dropdown-end">
                <div tabindex="0" role="button" class="btn btn-ghost btn-circle avatar">
                    <div class="w-10 h-10 rounded-full bg-primary flex items-center justify-center">
                        <span class="font-semibold text-white" style="font-size: 16px; line-height: 40px;">ç®¡</span>
                    </div>
                </div>
                <ul tabindex="0" class="menu menu-sm dropdown-content mt-3 z-50 p-2 shadow-lg bg-base-100 rounded-box w-52 border border-base-300">
                    <li class="menu-title"><span>ç®¡ç†å‘˜ä¸­å¿ƒ</span></li>
                    <li><a href="admins.html"><span class="iconify" data-icon="heroicons:user" data-width="16"></span>ä¸ªäººèµ„æ–™</a></li>
                    <li><a href="settings.html"><span class="iconify" data-icon="heroicons:cog-6-tooth" data-width="16"></span>ç³»ç»Ÿè®¾ç½®</a></li>
                    <li><a href="logs.html"><span class="iconify" data-icon="heroicons:clock" data-width="16"></span>æ“ä½œæ—¥å¿—</a></li>
                    <div class="divider my-1"></div>
                    <li><a onclick="handleLogout()" class="text-error"><span class="iconify" data-icon="heroicons:arrow-right-on-rectangle" data-width="16"></span>é€€å‡ºç™»å½•</a></li>
                </ul>
            </div>
        </div>
    </header>

    <!-- Main Layout -->
    <div class="flex">
        <!-- Sidebar -->
        <aside class="sidebar-wrapper bg-base-100 border-r border-base-300 min-h-screen">
            <!-- Sidebar Menu -->
            <ul class="menu p-3 gap-1 menu-sm pt-4">
                <li><a href="dashboard.html"><span class="iconify" data-icon="heroicons:home" data-width="18"></span><span>ä»ªè¡¨ç›˜</span></a></li>
                
                <li>
                    <details open>
                        <summary><span class="iconify text-blue-600" data-icon="heroicons:microphone" data-width="18"></span><span>è®²é“å†…å®¹</span></summary>
                        <ul>
                            <li><a href="sermons.html">è®²é“åˆ—è¡¨</a></li>
                            <li><a href="add-sermon.html">æ·»åŠ è®²é“</a></li>
                        </ul>
                    </details>
                </li>
                
                <li>
                    <details>
                        <summary><span class="iconify text-green-600" data-icon="heroicons:users" data-width="18"></span><span>è®²å‘˜ç®¡ç†</span></summary>
                        <ul>
                            <li><a href="speakers.html">è®²å‘˜åˆ—è¡¨</a></li>
                            <li><a href="add-speaker.html">æ·»åŠ è®²å‘˜</a></li>
                        </ul>
                    </details>
                </li>
                
                <li>
                    <details>
                        <summary><span class="iconify text-purple-600" data-icon="heroicons:squares-plus" data-width="18"></span><span>å†…å®¹ç¼–æ’</span></summary>
                        <ul>
                            <li><a href="curation.html">ç¼–æ’æ¦‚è§ˆ</a></li>
                            <li><a href="home-editor.html">é¦–é¡µæ¨¡å—</a></li>
                            <li><a href="discover-editor.html">å‘ç°é¡µæ¨¡å—</a></li>
                            <li><a href="launch-screen-editor.html">å¼€å±é¡µæ¨¡å—</a></li>
                        </ul>
                    </details>
                </li>
                
                <li>
                    <details>
                        <summary><span class="iconify text-orange-600" data-icon="heroicons:user-group" data-width="18"></span><span>ç”¨æˆ·ç®¡ç†</span></summary>
                        <ul>
                            <li><a href="users.html">æ‰€æœ‰ç”¨æˆ·</a></li>
                        </ul>
                    </details>
                </li>
                
                <li>
                    <details>
                        <summary><span class="iconify text-indigo-600" data-icon="heroicons:tag" data-width="18"></span><span>æ ‡ç­¾ä¸»é¢˜</span></summary>
                        <ul>
                            <li><a href="tags.html">æ ‡ç­¾ç®¡ç†</a></li>
                            <li><a href="tag-edit.html">æ ‡ç­¾ç¼–è¾‘</a></li>
                            <li><a href="topic-groups.html">ä¸»é¢˜ç»„</a></li>
                        </ul>
                    </details>
                </li>
                
                <li><a href="analytics.html"><span class="iconify text-red-600" data-icon="heroicons:chart-bar" data-width="18"></span><span>æ•°æ®ç»Ÿè®¡</span></a></li>
                
                <li>
                    <details>
                        <summary><span class="iconify text-gray-600" data-icon="heroicons:cog-6-tooth" data-width="18"></span><span>ç³»ç»Ÿè®¾ç½®</span></summary>
                        <ul>
                            <li><a href="settings.html">ç³»ç»Ÿæ¦‚è§ˆ</a></li>
                            <li><a href="admins.html">è´¦æˆ·ç®¡ç†</a></li>
                            <li><a href="permissions.html">æƒé™æ§åˆ¶</a></li>
                            <li><a href="api-config.html">APIé…ç½®</a></li>
                            <li><a href="logs.html">æ—¥å¿—ç‰ˆæœ¬</a></li>
                        </ul>
                    </details>
                </li>
                
                <li>
                    <details>
                        <summary><span class="iconify text-teal-600" data-icon="heroicons:question-mark-circle" data-width="18"></span><span>å¸®åŠ©ä¸­å¿ƒ</span></summary>
                        <ul>
                            <li><a href="help.html">å¸®åŠ©æ–‡æ¡£</a></li>
                            <li><a href="upload-guide.html">ä¸Šä¼ æŒ‡å—</a></li>
                            <li><a href="review-standards.html">å®¡æ ¸æ ‡å‡†</a></li>
                            <li><a href="contact.html">è”ç³»å¼€å‘è€…</a></li>
                        </ul>
                    </details>
                </li>
            </ul>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 flex flex-col">
            <!-- Breadcrumbs -->
            <div class="breadcrumbs text-sm py-3 px-6 bg-base-100 border-b border-base-300">
                <ul>
                    <li><a href="dashboard.html">é¦–é¡µ</a></li>
                    <li><a href="sermons.html">è®²é“å†…å®¹</a></li>
                    <li>è®²é“è¯¦æƒ…ä¸å®¡æ ¸</li>
                </ul>
            </div>

            <!-- Page Header -->
            <div class="px-8 py-6 bg-base-100 border-b border-base-300">
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-4">
                        <button class="btn btn-ghost btn-circle" onclick="location.href='sermons.html'">
                            <span class="iconify" data-icon="heroicons:arrow-left" data-width="20"></span>
                        </button>
                        <div>
                            <h1 class="text-2xl font-semibold">è®²é“è¯¦æƒ…å®¡æ ¸</h1>
                            <p class="text-sm text-base-content/70 mt-1">æŸ¥çœ‹è®²é“è¯¦ç»†ä¿¡æ¯å¹¶è¿›è¡Œå®¡æ ¸æ“ä½œ</p>
                        </div>
                    </div>
                    <div class="flex items-center gap-2">
                        <button id="editBtn" class="btn btn-primary" onclick="toggleEditMode()">
                            <span class="iconify" data-icon="heroicons:pencil-square" data-width="20"></span>
                            ç¼–è¾‘
                        </button>
                        <button id="saveBtn" class="btn btn-success hidden" onclick="saveChanges()">
                            <span class="iconify" data-icon="heroicons:check" data-width="20"></span>
                            ä¿å­˜
                        </button>
                        <button id="cancelBtn" class="btn btn-ghost hidden" onclick="cancelEdit()">
                            å–æ¶ˆ
                        </button>
                    </div>
                </div>
            </div>

            <!-- Content -->
            <div class="flex-1 p-8">
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 max-w-7xl mx-auto">
                    <!-- Left Column: Sermon Details -->
                    <div class="lg:col-span-2 space-y-6">
                        <!-- Main Info Card -->
                        <div class="card bg-base-100 shadow-sm border border-base-300">
                            <div class="card-body p-6">
                                <div class="flex items-start justify-between mb-4">
                                    <div class="flex-1">
                                        <!-- Title View -->
                                        <h2 class="text-xl font-semibold mb-2" data-mode="view" id="titleView">åŠ è½½ä¸­...</h2>
                                        <!-- Title Edit -->
                                        <input type="text" id="titleEdit" class="input input-bordered w-full mb-2 hidden" data-mode="edit" value="">
                                        
                                        <div class="flex items-center gap-4 text-sm text-base-content/70 mb-2">
                                            <!-- Date View -->
                                            <span class="flex items-center gap-1" data-mode="view">
                                                <span class="iconify" data-icon="heroicons:calendar" data-width="16"></span>
                                                <span id="dateView">--</span>
                                            </span>
                                            <!-- Date Edit -->
                                            <div class="flex items-center gap-1 hidden" data-mode="edit">
                                                <span class="iconify" data-icon="heroicons:calendar" data-width="16"></span>
                                                <input type="date" id="dateEdit" class="input input-bordered input-sm" value="">
                                            </div>
                                            
                                            <!-- Duration View (always readonly - from audio file) -->
                                            <span class="flex items-center gap-1">
                                                <span class="iconify" data-icon="heroicons:clock" data-width="16"></span>
                                                <span id="durationView">--</span>
                                            </span>
                                        </div>
                                    </div>
                                    <div class="status-indicator status-pending" id="headerStatus">
                                        <span class="iconify" data-icon="heroicons:clock" data-width="16"></span>
                                        å¾…å®¡æ ¸
                                    </div>
                                </div>

                                <!-- Cover Image -->
                                <div class="mb-6">
                                    <img id="coverPreview" src="https://spark-builder.s3.cn-north-1.amazonaws.com.cn/image/2025/10/22/b8f137a0-5f16-4365-9743-e5dcac798777.png" alt="è®²é“å°é¢" class="w-full h-64 object-cover rounded-lg">
                                    <input type="file" id="coverUpload" class="file-input file-input-bordered w-full mt-2 hidden" data-mode="edit" accept="image/*" onchange="previewCover(event)">
                                    <label class="label">
                                        <span class="label-text-alt text-base-content/60">æ¨èå›¾ç‰‡æ¯”ä¾‹ 3:2ï¼ˆä¾‹å¦‚ 1536Ã—1024ï¼‰</span>
                                    </label>
                                </div>

                                <!-- Summary -->
                                <div class="mb-6">
                                    <h3 class="text-lg font-medium mb-3">è®²é“æ‘˜è¦</h3>
                                    <!-- Summary View -->
                                    <p class="text-base-content/80 leading-relaxed" data-mode="view" id="summaryView">
                                        åŠ è½½ä¸­...
                                    </p>
                                    <!-- Summary Edit -->
                                    <textarea id="summaryEdit" class="textarea textarea-bordered w-full h-32 hidden" data-mode="edit"></textarea>
                                </div>

                                <!-- Scripture References -->
                                <div class="mb-6">
                                    <h3 class="text-lg font-medium mb-3">ç»æ–‡å¼•ç”¨</h3>
                                    <!-- Scripture View -->
                                    <div class="space-y-2" data-mode="view" id="scripturesView">
                                        <div class="text-base-content/60">åŠ è½½ä¸­...</div>
                                    </div>
                                    <!-- Scripture Edit -->
                                    <div class="space-y-2 hidden" data-mode="edit" id="scripturesEdit">
                                        <button class="btn btn-sm btn-ghost" id="addScriptureBtn" onclick="addScripture()">
                                            <span class="iconify" data-icon="heroicons:plus" data-width="16"></span>
                                            æ·»åŠ ç»æ–‡
                                        </button>
                                    </div>
                                </div>

                                <!-- Tags -->
                                <div>
                                    <h3 class="text-lg font-medium mb-3">æ ‡ç­¾</h3>
                                    <!-- Tags View -->
                                    <div class="flex flex-wrap gap-2" data-mode="view" id="tagsView">
                                        <div class="badge badge-primary badge-lg">æ©å…¸</div>
                                        <div class="badge badge-primary badge-lg">æ•‘èµ</div>
                                        <div class="badge badge-primary badge-lg">ä¿¡ä»°</div>
                                        <div class="badge badge-primary badge-lg">åœ£ç»æ•™å¯¼</div>
                                    </div>
                                    <!-- Tags Edit -->
                                    <div class="hidden" data-mode="edit">
                                        <div class="flex flex-wrap gap-2 mb-2 p-2 border border-base-300 rounded-lg min-h-12" id="tagContainerEdit">
                                            <span class="badge badge-md gap-1.5 cursor-pointer hover:badge-error" onclick="removeTag(this)">
                                                æ©å…¸
                                                <span class="iconify" data-icon="heroicons:x-mark" data-width="12"></span>
                                            </span>
                                            <span class="badge badge-md gap-1.5 cursor-pointer hover:badge-error" onclick="removeTag(this)">
                                                æ•‘èµ
                                                <span class="iconify" data-icon="heroicons:x-mark" data-width="12"></span>
                                            </span>
                                            <span class="badge badge-md gap-1.5 cursor-pointer hover:badge-error" onclick="removeTag(this)">
                                                ä¿¡ä»°
                                                <span class="iconify" data-icon="heroicons:x-mark" data-width="12"></span>
                                            </span>
                                            <span class="badge badge-md gap-1.5 cursor-pointer hover:badge-error" onclick="removeTag(this)">
                                                åœ£ç»æ•™å¯¼
                                                <span class="iconify" data-icon="heroicons:x-mark" data-width="12"></span>
                                            </span>
                                        </div>
                                        <input type="text" id="tagInputEdit" placeholder="è¾“å…¥æ ‡ç­¾åæŒ‰å›è½¦æ·»åŠ ..." class="input input-sm input-bordered w-full" onkeydown="handleTagInputEdit(event)">
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Speaker Info Card -->
                        <div class="card bg-base-100 shadow-sm border border-base-300">
                            <div class="card-body p-6">
                                <h3 class="text-lg font-medium mb-4">è®²å‘˜ä¿¡æ¯</h3>
                                <!-- Speaker View -->
                                <div class="flex items-start gap-4" data-mode="view">
                                    <div class="w-16 h-16 rounded-full overflow-hidden bg-primary text-primary-content flex items-center justify-center text-lg font-bold" id="speakerAvatarView">
                                        <!-- Avatar image or initials will be loaded here -->
                                    </div>
                                    <div class="flex-1">
                                        <h4 class="text-base font-medium mb-1" id="speakerNameView">åŠ è½½ä¸­...</h4>
                                        <p class="text-sm text-base-content/70 mb-2" id="speakerTitleView">--</p>
                                        <p class="text-sm text-base-content/80 leading-relaxed" id="speakerBioView">
                                            åŠ è½½ä¸­...
                                        </p>
                                    </div>
                                </div>
                                <!-- Speaker Edit -->
                                <div class="space-y-3 hidden" data-mode="edit">
                                    <div class="form-control">
                                        <label class="label"><span class="label-text">è®²å‘˜å§“å</span></label>
                                        <input type="text" id="speakerNameEdit" class="input input-bordered input-sm" value="">
                                    </div>
                                    <div class="form-control">
                                        <label class="label"><span class="label-text">èŒä½</span></label>
                                        <input type="text" id="speakerTitleEdit" class="input input-bordered input-sm" value="">
                                    </div>
                                    <div class="form-control">
                                        <label class="label"><span class="label-text">ç®€ä»‹</span></label>
                                        <textarea id="speakerBioEdit" class="textarea textarea-bordered h-24"></textarea>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Audio Preview Card -->
                        <div class="card bg-base-100 shadow-sm border border-base-300">
                            <div class="card-body p-6">
                                <h3 class="text-lg font-medium mb-4">éŸ³é¢‘é¢„è§ˆ</h3>
                                <div class="bg-base-200 rounded-lg p-4">
                                    <div class="flex items-center gap-4 mb-3">
                                        <button class="btn btn-circle btn-primary" id="playPauseBtn" onclick="toggleAudioPlayback()">
                                            <span class="iconify" data-icon="heroicons:play" data-width="20" id="playIcon"></span>
                                        </button>
                                        <div class="flex-1">
                                            <div class="text-sm font-medium mb-1" id="audioTitleView">åŠ è½½ä¸­...</div>
                                            <div class="text-xs text-base-content/70" id="audioMetaView">--</div>
                                        </div>
                                        <div class="text-sm text-base-content/70" id="audioTime">00:00 / 00:00</div>
                                    </div>
                                    <div class="w-full bg-base-300 rounded-full h-2 cursor-pointer" onclick="seekAudio(event)">
                                        <div class="bg-primary h-2 rounded-full transition-all duration-300" style="width: 0%" id="progressBar"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Right Column: Audit Actions -->
                    <div class="space-y-6">
                        <!-- Audit Status Card -->
                        <div class="card bg-base-100 shadow-sm border border-base-300">
                            <div class="card-body p-6">
                                <h3 class="text-lg font-medium mb-4">å®¡æ ¸çŠ¶æ€</h3>
                                <div class="space-y-3">
                                    <div class="flex items-center justify-between">
                                        <span class="text-sm text-base-content/70">å½“å‰çŠ¶æ€</span>
                                        <div class="status-indicator status-pending" id="sidebarStatus">
                                            <span class="iconify" data-icon="heroicons:clock" data-width="16"></span>
                                            å¾…å®¡æ ¸
                                        </div>
                                    </div>
                                    <div class="flex items-center justify-between">
                                        <span class="text-sm text-base-content/70">æäº¤æ—¶é—´</span>
                                        <span class="text-sm" id="submittedAtView">--</span>
                                    </div>
                                    <div class="flex items-center justify-between">
                                        <span class="text-sm text-base-content/70">æäº¤è€…</span>
                                        <a href="user-detail.html?id=user-10245" id="submitterView" class="text-sm text-primary hover:underline">å¼ å¼Ÿå…„</a>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Audit Actions Card -->
                        <div class="card bg-base-100 shadow-sm border border-base-300">
                            <div class="card-body p-6">
                                <h3 class="text-lg font-medium mb-4">å®¡æ ¸æ“ä½œ</h3>
                                <div class="space-y-3">
                                    <button class="btn btn-success w-full" onclick="approveSermon()">
                                        <span class="iconify" data-icon="heroicons:check-circle" data-width="20"></span>
                                        é€šè¿‡å®¡æ ¸
                                    </button>
                                    <button class="btn btn-warning w-full" onclick="requestRevision()">
                                        <span class="iconify" data-icon="heroicons:arrow-path" data-width="20"></span>
                                        é€€å›ä¿®æ”¹
                                    </button>
                                    <button class="btn btn-error w-full" onclick="showRejectModal()">
                                        <span class="iconify" data-icon="heroicons:x-circle" data-width="20"></span>
                                        æ‹’ç»ç”³è¯·
                                    </button>
                                </div>
                            </div>
                        </div>

                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Reject Modal -->
    <dialog id="rejectModal" class="modal">
        <div class="modal-box max-w-md">
            <h3 class="font-bold text-lg mb-4">æ‹’ç»ç”³è¯·</h3>
            <div class="space-y-4">
                <div class="form-control">
                    <label class="label">
                        <span class="label-text">æ‹’ç»ç†ç”±</span>
                    </label>
                    <textarea class="textarea textarea-bordered h-24 resize-none" placeholder="è¯·è¾“å…¥æ‹’ç»ç†ç”±..." id="rejectReason"></textarea>
                </div>
                <div class="form-control">
                    <label class="label">
                        <span class="label-text">å¸¸ç”¨ç†ç”±</span>
                    </label>
                    <select class="select select-bordered" onchange="fillRejectReason(this.value)">
                        <option value="">é€‰æ‹©å¸¸ç”¨ç†ç”±</option>
                        <option value="å†…å®¹ä¸ç¬¦åˆæ•™ä¼šæ•™ä¹‰">å†…å®¹ä¸ç¬¦åˆæ•™ä¼šæ•™ä¹‰</option>
                        <option value="éŸ³é¢‘è´¨é‡ä¸ä½³">éŸ³é¢‘è´¨é‡ä¸ä½³</option>
                        <option value="ç¼ºå°‘å¿…è¦çš„ç»æ–‡å¼•ç”¨">ç¼ºå°‘å¿…è¦çš„ç»æ–‡å¼•ç”¨</option>
                        <option value="å†…å®¹è¿‡äºç®€çŸ­">å†…å®¹è¿‡äºç®€çŸ­</option>
                        <option value="å…¶ä»–æŠ€æœ¯é—®é¢˜">å…¶ä»–æŠ€æœ¯é—®é¢˜</option>
                    </select>
                </div>
            </div>
            <div class="modal-action">
                <button class="btn btn-ghost" onclick="closeRejectModal()">å–æ¶ˆ</button>
                <button class="btn btn-error" onclick="confirmReject()">ç¡®è®¤æ‹’ç»</button>
            </div>
        </div>
        <form method="dialog" class="modal-backdrop">
            <button>close</button>
        </form>
    </dialog>

    <script>
        // Edit mode state
        let isEditMode = false;
        let originalData = {};

        // Toggle edit mode
        function toggleEditMode() {
            isEditMode = !isEditMode;
            
            if (isEditMode) {
                // Save original data
                saveOriginalData();
                // Show edit mode
                document.querySelectorAll('[data-mode="view"]').forEach(el => el.classList.add('hidden'));
                document.querySelectorAll('[data-mode="edit"]').forEach(el => el.classList.remove('hidden'));
                // Toggle buttons
                document.getElementById('editBtn').classList.add('hidden');
                document.getElementById('saveBtn').classList.remove('hidden');
                document.getElementById('cancelBtn').classList.remove('hidden');
            } else {
                // Show view mode
                document.querySelectorAll('[data-mode="view"]').forEach(el => el.classList.remove('hidden'));
                document.querySelectorAll('[data-mode="edit"]').forEach(el => el.classList.add('hidden'));
                // Toggle buttons
                document.getElementById('editBtn').classList.remove('hidden');
                document.getElementById('saveBtn').classList.add('hidden');
                document.getElementById('cancelBtn').classList.add('hidden');
            }
        }

        // Save original data
        function saveOriginalData() {
            originalData = {
                title: document.getElementById('titleEdit').value,
                date: document.getElementById('dateEdit').value,
                // duration is readonly - don't save to originalData
                summary: document.getElementById('summaryEdit').value,
                speakerName: document.getElementById('speakerNameEdit').value,
                speakerTitle: document.getElementById('speakerTitleEdit').value,
                speakerBio: document.getElementById('speakerBioEdit').value
            };
        }

        // Save changes
        async function saveChanges() {
            if (!confirm('ç¡®è®¤ä¿å­˜æ‰€æœ‰ä¿®æ”¹ï¼Ÿ')) {
                return;
            }

            // Collect all sermon data
            const sermonId = getSermonIdFromUrl();
            const sermonDataKey = `sermon_data_${sermonId}`;
            
            // è·å–å°é¢å›¾ç‰‡ URLï¼ˆä¼˜å…ˆä½¿ç”¨ä¸Šä¼ åçš„ URLï¼‰
            const coverPreview = document.getElementById('coverPreview');
            const coverImageUrl = coverPreview.dataset.uploadedUrl || coverPreview.src;
            
            // å¦‚æœæ˜¯ base64ï¼Œè¯´æ˜ç”¨æˆ·é€‰æ‹©äº†å›¾ç‰‡ä½†è¿˜æ²¡ä¸Šä¼ æˆåŠŸ
            if (coverImageUrl.startsWith('data:')) {
                alert('å°é¢å›¾ç‰‡è¿˜åœ¨ä¸Šä¼ ä¸­ï¼Œè¯·ç¨å€™å†ä¿å­˜');
                return;
            }
            
            const sermonData = {
                title: document.getElementById('titleEdit').value,
                date: document.getElementById('dateEdit').value,
                // duration is readonly - comes from audio file
                summary: document.getElementById('summaryEdit').value,
                scripture: Array.from(document.querySelectorAll('.scripture-input'))
                    .map(input => input.value.trim())
                    .filter(val => val)
                    .join('; '),
                tags: Array.from(document.getElementById('tagContainerEdit').querySelectorAll('.badge'))
                    .map(badge => badge.textContent.trim().replace('Ã—', '').trim()),
                speakerName: document.getElementById('speakerNameEdit').value,
                speakerTitle: document.getElementById('speakerTitleEdit').value,
                speakerBio: document.getElementById('speakerBioEdit').value,
                // Use uploaded R2 URL
                coverImage: coverImageUrl,
                savedAt: new Date().toISOString()
            };
            
            try {
                // Save to backend API
                const response = await fetch(`${APIConfig.baseURL}${APIConfig.apiVersion}/sermons/${sermonId}`, {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        title: sermonData.title,
                        date: sermonData.date,
                        // Don't update duration - it comes from audio file metadata
                        summary: sermonData.summary,
                        scripture: sermonData.scripture,
                        tags: sermonData.tags,
                        cover_image_url: sermonData.coverImage
                    })
                });
                
                if (!response.ok) {
                    throw new Error('API æ›´æ–°å¤±è´¥');
                }
                
                console.log('âœ… Sermon saved to API:', sermonData);
                
                // Save to localStorage
                localStorage.setItem(sermonDataKey, JSON.stringify(sermonData));
                console.log('âœ… Saved sermon data to localStorage');

                // Update view with edit values
                document.getElementById('titleView').textContent = sermonData.title;
                
                const dateFormatted = new Date(sermonData.date).toLocaleDateString('zh-CN');
                document.getElementById('dateView').textContent = dateFormatted;
                
                // Duration is readonly - don't update from save
                
                document.getElementById('summaryView').textContent = sermonData.summary;
                
                document.getElementById('speakerNameView').textContent = sermonData.speakerName;
                document.getElementById('speakerTitleView').textContent = sermonData.speakerTitle;
                document.getElementById('speakerBioView').textContent = sermonData.speakerBio;

                // Update scriptures view
                updateScripturesView();
                
                // Update tags view
                updateTagsView();

                // Exit edit mode
                document.querySelectorAll('[data-mode="view"]').forEach(el => el.classList.remove('hidden'));
                document.querySelectorAll('[data-mode="edit"]').forEach(el => el.classList.add('hidden'));
                document.getElementById('editBtn').classList.remove('hidden');
                document.getElementById('saveBtn').classList.add('hidden');
                document.getElementById('cancelBtn').classList.add('hidden');
                isEditMode = false;
                
                alert('ä¿®æ”¹å·²ä¿å­˜æˆåŠŸï¼');
                
            } catch (error) {
                console.error('âŒ ä¿å­˜å¤±è´¥:', error);
                alert('ä¿å­˜å¤±è´¥: ' + error.message);
            }
        }

        // Cancel edit
        function cancelEdit() {
            if (!confirm('ç¡®è®¤å–æ¶ˆç¼–è¾‘ï¼Ÿæœªä¿å­˜çš„ä¿®æ”¹å°†ä¸¢å¤±ã€‚')) {
                return;
            }

            // Restore original data
            document.getElementById('titleEdit').value = originalData.title;
            document.getElementById('dateEdit').value = originalData.date;
            // duration is readonly - don't restore
            document.getElementById('summaryEdit').value = originalData.summary;
            document.getElementById('speakerNameEdit').value = originalData.speakerName;
            document.getElementById('speakerTitleEdit').value = originalData.speakerTitle;
            document.getElementById('speakerBioEdit').value = originalData.speakerBio;

            // Exit edit mode
            document.querySelectorAll('[data-mode="view"]').forEach(el => el.classList.remove('hidden'));
            document.querySelectorAll('[data-mode="edit"]').forEach(el => el.classList.add('hidden'));
            document.getElementById('editBtn').classList.remove('hidden');
            document.getElementById('saveBtn').classList.add('hidden');
            document.getElementById('cancelBtn').classList.add('hidden');
            isEditMode = false;
        }

        // Preview cover image
        async function previewCover(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            try {
                // å…ˆæ˜¾ç¤ºæœ¬åœ°é¢„è§ˆ
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('coverPreview').src = e.target.result;
                };
                reader.readAsDataURL(file);
                
                // ä¸Šä¼ åˆ° R2
                console.log('ğŸ“¤ å¼€å§‹ä¸Šä¼ å°é¢å›¾ç‰‡åˆ° R2...');
                const formData = new FormData();
                formData.append('file', file);
                formData.append('type', 'sermon');
                
                const response = await fetch(`${APIConfig.baseURL}${APIConfig.apiVersion}/upload/image`, {
                    method: 'POST',
                    body: formData
                });
                
                if (!response.ok) {
                    throw new Error('ä¸Šä¼ å¤±è´¥');
                }
                
                const result = await response.json();
                if (!result.success || !result.data?.url) {
                    throw new Error('ä¸Šä¼ è¿”å›æ ¼å¼é”™è¯¯');
                }
                
                // ä¿å­˜ä¸Šä¼ åçš„ URL
                const uploadedUrl = result.data.url;
                console.log('âœ… å›¾ç‰‡ä¸Šä¼ æˆåŠŸ:', uploadedUrl);
                
                // æ›´æ–°é¢„è§ˆå›¾ç‰‡ä¸º R2 URL
                document.getElementById('coverPreview').src = uploadedUrl;
                document.getElementById('coverPreview').dataset.uploadedUrl = uploadedUrl;
                
                alert('å°é¢å›¾ç‰‡ä¸Šä¼ æˆåŠŸï¼');
            } catch (error) {
                console.error('âŒ ä¸Šä¼ å°é¢å¤±è´¥:', error);
                alert('ä¸Šä¼ å°é¢å¤±è´¥: ' + error.message);
            }
        }

        // Scripture management
        function addScripture() {
            const container = document.getElementById('scripturesEdit');
            const addButton = document.getElementById('addScriptureBtn');
            
            if (!container) {
                console.error('Scripture edit container not found');
                return;
            }
            
            const newScripture = document.createElement('div');
            newScripture.className = 'flex items-center gap-2';
            newScripture.innerHTML = `
                <input type="text" class="input input-bordered input-sm flex-1 scripture-input" placeholder="è¯·è¾“å…¥ç»æ–‡å¼•ç”¨ï¼Œå¦‚ï¼šçº¦ç¿°ç¦éŸ³ 3:16">
                <button class="btn btn-ghost btn-sm btn-circle" onclick="removeScripture(this)">
                    <span class="iconify" data-icon="heroicons:x-mark" data-width="16"></span>
                </button>
            `;
            
            // Insert before the add button
            if (addButton) {
                container.insertBefore(newScripture, addButton);
                console.log('Added new scripture input field');
            } else {
                console.error('Add scripture button not found');
            }
        }

        function removeScripture(button) {
            button.closest('div').remove();
        }

        function updateScripturesView() {
            const inputs = document.querySelectorAll('.scripture-input');
            const viewContainer = document.getElementById('scripturesView');
            viewContainer.innerHTML = '';
            
            inputs.forEach(input => {
                if (input.value.trim()) {
                    const scriptureDiv = document.createElement('div');
                    scriptureDiv.className = 'flex items-center gap-2 p-3 bg-base-200 rounded-lg';
                    scriptureDiv.innerHTML = `
                        <span class="iconify text-primary" data-icon="heroicons:book-open" data-width="16"></span>
                        <span class="font-medium">${input.value}</span>
                    `;
                    viewContainer.appendChild(scriptureDiv);
                }
            });
        }

        // Tag management
        function handleTagInputEdit(event) {
            if (event.key === 'Enter') {
                event.preventDefault();
                const input = event.target;
                const value = input.value.trim();
                
                if (value) {
                    const container = document.getElementById('tagContainerEdit');
                    const newTag = document.createElement('span');
                    newTag.className = 'badge badge-md gap-1.5 cursor-pointer hover:badge-error';
                    newTag.onclick = function() { removeTag(this); };
                    newTag.innerHTML = `
                        ${value}
                        <span class="iconify" data-icon="heroicons:x-mark" data-width="12"></span>
                    `;
                    container.appendChild(newTag);
                    input.value = '';
                }
            }
        }

        function removeTag(element) {
            element.remove();
        }

        function updateTagsView() {
            const editTags = document.querySelectorAll('#tagContainerEdit .badge');
            const viewContainer = document.getElementById('tagsView');
            viewContainer.innerHTML = '';
            
            editTags.forEach(tag => {
                const tagText = tag.childNodes[0].textContent.trim();
                const newTag = document.createElement('div');
                newTag.className = 'badge badge-primary badge-lg';
                newTag.textContent = tagText;
                viewContainer.appendChild(newTag);
            });
        }

        // Audio player state
        let isPlaying = false;
        let currentTime = 0;
        let duration = 0; // Will be set from sermon data
        let audioInterval;
        let audioElement = null; // HTML5 Audio element for actual playback

        // Initialize audio element
        function initAudioElement() {
            if (!audioElement && window.currentSermonAudioUrl) {
                audioElement = new Audio(window.currentSermonAudioUrl);
                
                // Update time display as audio plays
                audioElement.addEventListener('timeupdate', function() {
                    if (audioElement && !audioElement.paused) {
                        currentTime = Math.floor(audioElement.currentTime);
                        updateAudioDisplay();
                    }
                });
                
                // Handle audio end
                audioElement.addEventListener('ended', function() {
                    isPlaying = false;
                    currentTime = 0;
                    document.getElementById('playIcon').setAttribute('data-icon', 'heroicons:play');
                    updateAudioDisplay();
                });
                
                // Update duration when metadata loads
                audioElement.addEventListener('loadedmetadata', function() {
                    if (audioElement.duration && audioElement.duration !== Infinity) {
                        duration = Math.floor(audioElement.duration);
                        updateAudioDisplay();
                    }
                });
            }
        }

        // Audio player functions
        function toggleAudioPlayback() {
            const playIcon = document.getElementById('playIcon');
            
            // Initialize audio element if not already done
            initAudioElement();
            
            if (!audioElement) {
                alert('éŸ³é¢‘æ–‡ä»¶å°šæœªåŠ è½½ï¼Œè¯·ç¨åå†è¯•');
                return;
            }
            
            if (isPlaying) {
                isPlaying = false;
                audioElement.pause();
                playIcon.setAttribute('data-icon', 'heroicons:play');
            } else {
                isPlaying = true;
                audioElement.play().catch(err => {
                    console.error('æ’­æ”¾å¤±è´¥:', err);
                    isPlaying = false;
                    playIcon.setAttribute('data-icon', 'heroicons:play');
                    alert('æ’­æ”¾å¤±è´¥ï¼Œè¯·æ£€æŸ¥éŸ³é¢‘æ–‡ä»¶');
                });
                playIcon.setAttribute('data-icon', 'heroicons:pause');
            }
        }

        function updateAudioDisplay() {
            const progressBar = document.getElementById('progressBar');
            const audioTime = document.getElementById('audioTime');
            
            if (progressBar) {
                const progress = (currentTime / duration) * 100;
                progressBar.style.width = progress + '%';
            }
            
            if (audioTime) {
                const currentFormatted = formatTime(currentTime);
                const durationFormatted = formatTime(duration);
                audioTime.textContent = `${currentFormatted} / ${durationFormatted}`;
            }
        }

        function seekAudio(event) {
            const progressContainer = event.currentTarget;
            const rect = progressContainer.getBoundingClientRect();
            const clickX = event.clientX - rect.left;
            const percentage = clickX / rect.width;
            
            currentTime = Math.floor(duration * percentage);
            
            // Update audio element currentTime if exists
            if (audioElement) {
                audioElement.currentTime = currentTime;
            }
            
            updateAudioDisplay();
        }

        function formatTime(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
        }

        // Audit action functions
        async function approveSermon() {
            if (confirm('ç¡®è®¤é€šè¿‡æ­¤è®²é“å®¡æ ¸ï¼Ÿ')) {
                const sermonId = getSermonIdFromUrl();
                
                try {
                    // Update status in backend API
                    const response = await fetch(`${APIConfig.baseURL}${APIConfig.apiVersion}/sermons/${sermonId}`, {
                        method: 'PATCH',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ status: 'published' })
                    });
                    
                    if (!response.ok) {
                        throw new Error('API æ›´æ–°å¤±è´¥');
                    }
                    
                    // Update status display
                    updateStatusDisplay('published');
                    
                    // Save status to localStorage
                    saveSermonStatus('published');
                    
                    // Show success message
                    alert('è®²é“å®¡æ ¸å·²é€šè¿‡ï¼ŒçŠ¶æ€å·²æ›´æ–°ä¸º"å·²å‘å¸ƒ"');
                    
                    console.log(`âœ… Sermon ${sermonId} status updated to 'published' in API`);
                } catch (error) {
                    console.error('æ›´æ–°çŠ¶æ€å¤±è´¥:', error);
                    alert('æ›´æ–°å¤±è´¥: ' + error.message);
                }
            }
        }

        async function requestRevision() {
            if (confirm('ç¡®è®¤é€€å›æ­¤è®²é“è¦æ±‚ä¿®æ”¹ï¼Ÿ')) {
                const sermonId = getSermonIdFromUrl();
                
                try {
                    // Update status in backend API
                    const response = await fetch(`${APIConfig.baseURL}${APIConfig.apiVersion}/sermons/${sermonId}`, {
                        method: 'PATCH',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ status: 'revision' })
                    });
                    
                    if (!response.ok) {
                        throw new Error('API æ›´æ–°å¤±è´¥');
                    }
                    
                    // Update status display
                    updateStatusDisplay('revision');
                    
                    // Save status to localStorage
                    saveSermonStatus('revision');
                    
                    // Show success message
                    alert('å·²é€€å›è¦æ±‚ä¿®æ”¹ï¼ŒçŠ¶æ€å·²æ›´æ–°ä¸º"å·²é€€å›"');
                    
                    console.log(`âœ… Sermon ${sermonId} status updated to 'revision' in API`);
                } catch (error) {
                    console.error('æ›´æ–°çŠ¶æ€å¤±è´¥:', error);
                    alert('æ›´æ–°å¤±è´¥: ' + error.message);
                }
            }
        }

        // Reject modal functions
        function showRejectModal() {
            const modal = document.getElementById('rejectModal');
            if (modal) {
                modal.showModal();
            }
        }

        function closeRejectModal() {
            const modal = document.getElementById('rejectModal');
            const textarea = document.getElementById('rejectReason');
            const select = modal.querySelector('select');
            
            if (modal) {
                modal.close();
            }
            if (textarea) {
                textarea.value = '';
            }
            if (select) {
                select.value = '';
            }
        }

        function fillRejectReason(reason) {
            const textarea = document.getElementById('rejectReason');
            if (textarea && reason) {
                textarea.value = reason;
            }
        }

        async function confirmReject() {
            const textarea = document.getElementById('rejectReason');
            const reason = textarea ? textarea.value.trim() : '';
            
            if (!reason) {
                alert('è¯·è¾“å…¥æ‹’ç»ç†ç”±');
                return;
            }
            
            if (confirm('ç¡®è®¤æ‹’ç»æ­¤è®²é“ç”³è¯·ï¼Ÿ')) {
                const sermonId = getSermonIdFromUrl();
                
                try {
                    // Update status in backend API
                    const response = await fetch(`${APIConfig.baseURL}${APIConfig.apiVersion}/sermons/${sermonId}`, {
                        method: 'PATCH',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ 
                            status: 'rejected',
                            rejection_reason: reason
                        })
                    });
                    
                    if (!response.ok) {
                        throw new Error('API æ›´æ–°å¤±è´¥');
                    }
                    
                    // Update status display
                    updateStatusDisplay('rejected');
                    
                    // Save status to localStorage
                    saveSermonStatus('rejected');
                    
                    // Show success message
                    alert('å·²æ‹’ç»ç”³è¯·ï¼ŒçŠ¶æ€å·²æ›´æ–°ä¸º"å·²æ‹’ç»"');
                    closeRejectModal();
                    
                    console.log(`âœ… Sermon ${sermonId} status updated to 'rejected' in API`);
                } catch (error) {
                    console.error('æ›´æ–°çŠ¶æ€å¤±è´¥:', error);
                    alert('æ›´æ–°å¤±è´¥: ' + error.message);
                }
            }
        }

        // Logout function
        function handleLogout() {
            localStorage.removeItem('admin_token');
            localStorage.removeItem('admin_username');
            window.location.href = 'login.html';
        }

        // Function to get sermon ID from URL
        function getSermonIdFromUrl() {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get('id') || 'sermon-001'; // Default for demo
        }

        // Script version: 2025-11-06 v1 - Added API calls for status updates
        console.log('sermon-detail.html script loaded: v2025-11-06-v1');
        
        // Default sermon data for each sermon ID (matching seed.json)
        const defaultSermonData = {
            'sermon-001': {
                title: 'ä¿¡å¿ƒçš„åŠ›é‡ï¼šåœ¨å›°å¢ƒä¸­å¯»æ‰¾å¸Œæœ›',
                date: '2025-10-27',
                duration: '43',
                summary: 'åœ¨æˆ‘ä»¬ç”Ÿå‘½çš„æ¯ä¸€å¤©ï¼Œéƒ½éœ€è¦å›åˆ°ä¿¡ä»°çš„æ ¹åŸºä¸Šå»ï¼Œæ‰èƒ½ç«™ç«‹å¾—ç¨³ã€‚æœ¬è®²é“æ¢è®¨å¦‚ä½•åœ¨å›°å¢ƒä¸­ä¿æŒä¿¡å¿ƒï¼Œå¹¶æ‰¾åˆ°ç¥èµäºˆçš„å¸Œæœ›ã€‚',
                scriptures: ['å¸Œä¼¯æ¥ä¹¦ 11:1'],
                tags: ['ä¿¡å¿ƒ', 'å¸Œæœ›', 'å›°å¢ƒ'],
                speakerName: 'çº¦ç¿°Â·å²å¯†æ–¯',
                speakerTitle: 'ä¸»ä»»ç‰§å¸ˆ',
                speakerBio: 'åœ¨ç‰§ä¼šæœäº‹è¶…è¿‡20å¹´ï¼Œä¸“æ³¨äºè®²è§£åœ£ç»çœŸç†ï¼Œå¸®åŠ©ä¿¡å¾’åœ¨ä¿¡ä»°ä¸Šæˆé•¿ã€‚',
                submitter: 'ç‹å°æ˜',
                coverImage: 'https://images.unsplash.com/photo-1560131542-8637f14c4e64',
                status: 'published'  // Default status from seed.json
            },
            'sermon-002': {
                title: 'ç¥·å‘Šçš„æ·±åº¦ï¼šä¸ç¥å»ºç«‹æ›´æ·±å…³ç³»',
                date: '2025-10-26',
                duration: '35',
                summary: 'æ·±å…¥æ¢è®¨ç¥·å‘Šçš„æœ¬è´¨ï¼Œå­¦ä¹ å¦‚ä½•é€è¿‡ç¥·å‘Šä¸ç¥å»ºç«‹æ›´äº²å¯†çš„å…³ç³»ã€‚åŒ…æ‹¬ç¥·å‘Šçš„åŸåˆ™ã€æ–¹æ³•å’Œå®é™…æ“ç»ƒã€‚',
                scriptures: ['é©¬å¤ªç¦éŸ³ 6:9-13'],
                tags: ['ç¥·å‘Š', 'çµä¿®', 'é—¨å¾’è®­ç»ƒ'],
                speakerName: 'ç›ä¸½Â·çº¦ç¿°é€Š',
                speakerTitle: 'å‰¯ç‰§å¸ˆ',
                speakerBio: 'çƒ­å¿ƒäºç¥·å‘Šäº‹å·¥å’Œçµä¿®è¾…å¯¼ï¼Œè‡´åŠ›äºå¸®åŠ©ä¿¡å¾’å»ºç«‹ä¸ç¥æ›´æ·±çš„å…³ç³»ã€‚',
                submitter: 'æå§å¦¹',
                coverImage: 'https://images.unsplash.com/photo-1551847653-6740008053b5',
                status: 'published'  // Default status from seed.json
            },
            'sermon-003': {
                title: 'ç¥çš„æ©å…¸ï¼šè¶…è¶Šæˆ‘ä»¬çš„ç†è§£',
                date: '2025-10-25',
                duration: '38',
                summary: 'ç¥çš„æ©å…¸æ˜¯ç™½ç™½èµç»™æˆ‘ä»¬çš„ç¤¼ç‰©ï¼Œæ— éœ€æˆ‘ä»¬å‡­è¡Œä¸ºèµšå–ã€‚æœ¬è®²é“å¸®åŠ©æˆ‘ä»¬æ›´æ·±åˆ»åœ°ç†è§£æ©å…¸çš„å«ä¹‰å’Œåœ¨ç”Ÿæ´»ä¸­çš„åº”ç”¨ã€‚',
                scriptures: ['ä»¥å¼—æ‰€ä¹¦ 2:8-9'],
                tags: ['æ©å…¸', 'æ•‘æ©', 'ä¿¡ä»°'],
                speakerName: 'ä¿ç½—Â·å®‰å¾·æ£®',
                speakerTitle: 'ä¼ é“å¸ˆ',
                speakerBio: 'ä¸“æ³¨äºç¥å­¦æ•™å¯¼å’Œé—¨å¾’è®­ç»ƒï¼Œå¸®åŠ©ä¿¡å¾’å»ºç«‹æ‰å®çš„åœ£ç»æ ¹åŸºã€‚',
                submitter: 'å¼ å¼Ÿå…„',
                coverImage: 'https://images.unsplash.com/photo-1649774472544-d1417fd66a34',
                status: 'published'  // Default status from seed.json
            }
        };

        // Function to load sermon status - now loaded from API in loadSavedSermonData()
        function loadSermonStatus() {
            // Status is now loaded from API in loadSavedSermonData()
            // This function is kept for backwards compatibility but does nothing
            console.log('Status will be loaded from API');
        }

        // Function to update status display
        function updateStatusDisplay(status) {
            const statusConfig = {
                'pending': {
                    className: 'status-pending',
                    icon: 'heroicons:clock',
                    text: 'å¾…å®¡æ ¸'
                },
                'published': {
                    className: 'status-published',
                    icon: 'heroicons:check-circle',
                    text: 'å·²å‘å¸ƒ'
                },
                'approved': {  // Keep for backwards compatibility
                    className: 'status-published',
                    icon: 'heroicons:check-circle',
                    text: 'å·²å‘å¸ƒ'
                },
                'rejected': {
                    className: 'status-rejected',
                    icon: 'heroicons:x-circle',
                    text: 'å·²æ‹’ç»'
                },
                'revision': {
                    className: 'status-revision',
                    icon: 'heroicons:arrow-path',
                    text: 'å·²é€€å›'
                }
            };

            const config = statusConfig[status] || statusConfig['pending'];
            console.log(`Updating status display:`, { status, config, hasConfig: !!statusConfig[status] });
            
            const statusIndicators = document.querySelectorAll('.status-indicator');
            console.log(`Found ${statusIndicators.length} status indicators`);
            
            statusIndicators.forEach(indicator => {
                indicator.className = `status-indicator ${config.className}`;
                indicator.innerHTML = `
                    <span class="iconify" data-icon="${config.icon}" data-width="16"></span>
                    ${config.text}
                `;
            });
        }

        // Function to save sermon status
        function saveSermonStatus(status) {
            const sermonId = getSermonIdFromUrl();
            const statusKey = `sermon_status_${sermonId}`;
            localStorage.setItem(statusKey, status);
        }

        // Load saved sermon data
        async function loadSavedSermonData() {
            const sermonId = getSermonIdFromUrl();
            const sermonDataKey = `sermon_data_${sermonId}`;
            const savedData = localStorage.getItem(sermonDataKey);
            
            // First, try to load from API
            try {
                const response = await fetch(`${APIConfig.baseURL}${APIConfig.apiVersion}/sermons/${sermonId}`);
                if (response.ok) {
                    const result = await response.json();
                    const apiData = result.data;
                    
                    // Transform API data to page format
                    const sermonData = {
                        title: apiData.title,
                        date: apiData.date.split('T')[0],
                        duration: apiData.duration, // Keep as seconds from API
                        summary: apiData.summary,
                        scriptures: apiData.scripture ? apiData.scripture.split(';').map(s => s.trim()) : [],
                        tags: apiData.tags || [],
                        speakerName: apiData.speaker?.name || '',
                        speakerTitle: apiData.speaker?.title || '',
                        speakerBio: apiData.speaker?.bio || '',
                        speakerAvatarURL: apiData.speaker?.avatar_url || '',
                        submitter: apiData.submitter?.email || apiData.submitter?.username || '',
                        submitterId: apiData.submitter?.id || apiData.submitter_id || '',
                        coverImage: apiData.cover_image_url || '',
                        audioUrl: apiData.audio_url || '',
                        audioSize: apiData.audio_size || 0,
                        playCount: apiData.play_count || 0,
                        favoriteCount: apiData.favorite_count || 0,
                        createdAt: apiData.created_at || '',
                        status: apiData.status || 'pending'
                    };
                    
                    console.log('âœ… Loaded sermon data from API:', sermonData);
                    loadSermonDataIntoPage(sermonData);
                    
                    // Update status display with API data
                    if (apiData.status) {
                        updateStatusDisplay(apiData.status);
                    }
                    
                    return;
                }
            } catch (error) {
                console.error('âŒ Failed to load from API:', error);
            }
            
            // Fallback: load default data if available
            const defaultData = defaultSermonData[sermonId];
            if (defaultData) {
                loadSermonDataIntoPage(defaultData);
            }
            
            // Then, if there's saved data, override with saved data
            if (savedData) {
                try {
                    const sermonData = JSON.parse(savedData);
                    console.log('Loading saved sermon data (overriding defaults):', sermonData);
                    loadSermonDataIntoPage(sermonData);
                    console.log('Successfully loaded saved sermon data');
                } catch (e) {
                    console.error('Error loading saved sermon data:', e);
                }
            } else {
                console.log('No saved data found, using default/API data');
            }
        }

        // Function to load sermon data into the page
        function loadSermonDataIntoPage(sermonData) {
            // Update view mode displays
            document.getElementById('titleView').textContent = sermonData.title;
            document.getElementById('titleEdit').value = sermonData.title;
            
            // Format date as YYYYå¹´MMæœˆDDæ—¥
            const dateParts = sermonData.date.split('-');
            const dateFormatted = `${dateParts[0]}å¹´${dateParts[1]}æœˆ${dateParts[2]}æ—¥`;
            document.getElementById('dateView').textContent = dateFormatted;
            document.getElementById('dateEdit').value = sermonData.date;
            
            // Format duration: convert seconds to minutes:seconds or just minutes
            const durationInSeconds = parseInt(sermonData.duration);
            let durationText;
            if (durationInSeconds >= 60) {
                const minutes = Math.floor(durationInSeconds / 60);
                const seconds = durationInSeconds % 60;
                durationText = seconds > 0 ? `${minutes}åˆ†${seconds}ç§’` : `${minutes}åˆ†é’Ÿ`;
            } else {
                durationText = `${durationInSeconds}ç§’`;
            }
            document.getElementById('durationView').textContent = durationText;
            
            document.getElementById('summaryView').textContent = sermonData.summary;
            document.getElementById('summaryEdit').value = sermonData.summary;
            
            document.getElementById('speakerNameView').textContent = sermonData.speakerName;
            document.getElementById('speakerNameEdit').value = sermonData.speakerName;
            
            document.getElementById('speakerTitleView').textContent = sermonData.speakerTitle;
            document.getElementById('speakerTitleEdit').value = sermonData.speakerTitle;
            
            document.getElementById('speakerBioView').textContent = sermonData.speakerBio;
            document.getElementById('speakerBioEdit').value = sermonData.speakerBio;
            
            // Update speaker avatar
            const speakerAvatarView = document.getElementById('speakerAvatarView');
            if (speakerAvatarView) {
                if (sermonData.speakerAvatarURL) {
                    // Show avatar image
                    speakerAvatarView.innerHTML = `<img src="${sermonData.speakerAvatarURL}" alt="${sermonData.speakerName}" class="w-full h-full object-cover">`;
                } else {
                    // Show initials
                    const initials = sermonData.speakerName ? sermonData.speakerName.substring(0, 2) : 'è®²';
                    speakerAvatarView.innerHTML = initials;
                }
            }
            
            // Update submitter if available
            if (sermonData.submitter) {
                const submitterView = document.getElementById('submitterView');
                if (submitterView) {
                    submitterView.textContent = sermonData.submitter;
                    
                    // Update link to correct user detail page
                    if (sermonData.submitterId) {
                        submitterView.href = `user-detail.html?id=${sermonData.submitterId}`;
                    }
                }
            }
            
            // Update submitted time (created_at)
            if (sermonData.createdAt) {
                const submittedAtView = document.getElementById('submittedAtView');
                if (submittedAtView) {
                    const createdDate = new Date(sermonData.createdAt);
                    const formattedDateTime = `${createdDate.getFullYear()}-${String(createdDate.getMonth() + 1).padStart(2, '0')}-${String(createdDate.getDate()).padStart(2, '0')} ${String(createdDate.getHours()).padStart(2, '0')}:${String(createdDate.getMinutes()).padStart(2, '0')}`;
                    submittedAtView.textContent = formattedDateTime;
                }
            }
            
            // Update cover image if saved
            if (sermonData.coverImage) {
                document.getElementById('coverPreview').src = sermonData.coverImage;
            }
            
            // Update audio URL for playback
            if (sermonData.audioUrl) {
                window.currentSermonAudioUrl = sermonData.audioUrl;
                // Update duration from sermonData
                if (sermonData.duration) {
                    window.duration = parseInt(sermonData.duration);
                }
            }
            
            // Update audio preview section
            const audioTitleView = document.getElementById('audioTitleView');
            const audioMetaView = document.getElementById('audioMetaView');
            if (audioTitleView) {
                audioTitleView.textContent = sermonData.title || 'æœªå‘½åè®²é“';
            }
            if (audioMetaView) {
                const dateParts = sermonData.date.split('-');
                const dateFormatted = `${dateParts[0]}å¹´${dateParts[1]}æœˆ${dateParts[2]}æ—¥`;
                audioMetaView.textContent = `${sermonData.speakerName || 'æœªçŸ¥è®²å‘˜'} â€¢ ${dateFormatted}`;
            }
            
            // Load scriptures
            if (sermonData.scriptures && sermonData.scriptures.length > 0) {
                // Update view
                const scripturesView = document.getElementById('scripturesView');
                scripturesView.innerHTML = '';
                sermonData.scriptures.forEach(scripture => {
                    const scriptureDiv = document.createElement('div');
                    scriptureDiv.className = 'flex items-center gap-2 p-3 bg-base-200 rounded-lg';
                    scriptureDiv.innerHTML = `
                        <span class="iconify text-primary" data-icon="heroicons:book-open" data-width="16"></span>
                        <span class="font-medium">${scripture}</span>
                    `;
                    scripturesView.appendChild(scriptureDiv);
                });
                
                // Update edit inputs
                const scripturesEdit = document.getElementById('scripturesEdit');
                const addButton = document.getElementById('addScriptureBtn');
                // Remove existing inputs
                scripturesEdit.querySelectorAll('.flex.items-center.gap-2').forEach(el => el.remove());
                // Add saved scriptures
                sermonData.scriptures.forEach(scripture => {
                    const newScripture = document.createElement('div');
                    newScripture.className = 'flex items-center gap-2';
                    newScripture.innerHTML = `
                        <input type="text" class="input input-bordered input-sm flex-1 scripture-input" value="${scripture}">
                        <button class="btn btn-ghost btn-sm btn-circle" onclick="removeScripture(this)">
                            <span class="iconify" data-icon="heroicons:x-mark" data-width="16"></span>
                        </button>
                    `;
                    scripturesEdit.insertBefore(newScripture, addButton);
                });
            }
            
            // Load tags
            if (sermonData.tags && sermonData.tags.length > 0) {
                // Update view
                const tagsView = document.getElementById('tagsView');
                tagsView.innerHTML = '';
                sermonData.tags.forEach(tag => {
                    const badge = document.createElement('div');
                    badge.className = 'badge badge-primary badge-lg';
                    badge.textContent = tag;
                    tagsView.appendChild(badge);
                });
                
                // Update edit
                const tagContainerEdit = document.getElementById('tagContainerEdit');
                tagContainerEdit.innerHTML = '';
                sermonData.tags.forEach(tag => {
                    const badge = document.createElement('span');
                    badge.className = 'badge badge-md gap-1.5 cursor-pointer hover:badge-error';
                    badge.onclick = function() { removeTag(this); };
                    badge.innerHTML = `
                        ${tag}
                        <span class="iconify" data-icon="heroicons:x-mark" data-width="12"></span>
                    `;
                    tagContainerEdit.appendChild(badge);
                });
            }
        }

        // Initialize audio display on load
        document.addEventListener('DOMContentLoaded', function() {
            updateAudioDisplay();
            loadSermonStatus();
            loadSavedSermonData();
        });
    </script>
</body>
</html>

