<!DOCTYPE html>
<html lang="zh-CN" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¸»é¢˜ç»„ç®¡ç† - å¬é“åå°ç®¡ç†ç³»ç»Ÿ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/daisyui@4.4.19/dist/full.min.css" rel="stylesheet" type="text/css" />
    <script src="https://code.iconify.design/3/3.1.1/iconify.min.js"></script>
    <style>
        body {
            font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        }

        .sidebar-wrapper {
            width: 220px;
            flex-shrink: 0;
        }

        .sidebar-text {
            white-space: nowrap;
        }
    </style>

    <!-- API Client -->
    <script src="js/api-config.js?v=20251104"></script>
    <script src="js/api-client.js?v=20251104"></script>
    <script src="js/api-services.js?v=20251104"></script>
    <script src="js/curation-api.js?v=20251104"></script>
    </head>
<body class="bg-base-200 flex flex-col min-h-screen">
    <div class="flex flex-1">
        <!-- Sidebar -->
        <aside class="sidebar-wrapper bg-base-100 border-r border-base-300">
            <div class="p-3 border-b border-base-300">
                <div class="flex items-center gap-2.5">
                    <div class="w-9 h-9 bg-primary rounded-lg flex items-center justify-center">
                        <span class="iconify text-white" data-icon="heroicons:home" data-width="20"></span>
                    </div>
                    <span class="sidebar-text text-lg font-semibold">å¬é“åå°</span>
                </div>
            </div>

            <ul class="menu menu-sm gap-1 p-3">
                <li><a href="dashboard.html"><span class="iconify" data-icon="heroicons:home" data-width="18"></span><span class="sidebar-text">ä»ªè¡¨ç›˜</span></a></li>
                
                <li>
                    <details>
                        <summary><span class="iconify text-blue-600" data-icon="heroicons:microphone" data-width="18"></span><span class="sidebar-text">è®²é“å†…å®¹</span></summary>
                        <ul>
                            <li><a href="sermons.html">è®²é“åˆ—è¡¨</a></li>
                            <li><a href="add-sermon.html">æ·»åŠ è®²é“</a></li>
                        </ul>
                    </details>
                </li>
                
                <li>
                    <details>
                        <summary><span class="iconify text-green-600" data-icon="heroicons:users" data-width="18"></span><span class="sidebar-text">è®²å‘˜ç®¡ç†</span></summary>
                        <ul>
                            <li><a href="speakers.html">è®²å‘˜åˆ—è¡¨</a></li>
                            <li><a href="add-speaker.html">æ·»åŠ è®²å‘˜</a></li>
                        </ul>
                    </details>
                </li>
                
                <li>
                    <details>
                        <summary><span class="iconify text-purple-600" data-icon="heroicons:squares-plus" data-width="18"></span><span class="sidebar-text">å†…å®¹ç¼–æ’</span></summary>
                        <ul>
                            <li><a href="curation.html">ç¼–æ’æ¦‚è§ˆ</a></li>
                            <li><a href="home-editor.html">é¦–é¡µæ¨¡å—</a></li>
                            <li><a href="discover-editor.html">å‘ç°é¡µæ¨¡å—</a></li>
                            <li><a href="launch-screen-editor.html">å¼€å±é¡µæ¨¡å—</a></li>
                        </ul>
                    </details>
                </li>
                
                <li>
                    <details>
                        <summary><span class="iconify text-orange-600" data-icon="heroicons:user-group" data-width="18"></span><span class="sidebar-text">ç”¨æˆ·ç®¡ç†</span></summary>
                        <ul>
                            <li><a href="users.html">æ‰€æœ‰ç”¨æˆ·</a></li>
                        </ul>
                    </details>
                </li>
                
                <li>
                    <details open>
                        <summary><span class="iconify text-indigo-600" data-icon="heroicons:tag" data-width="18"></span><span class="sidebar-text">æ ‡ç­¾ä¸»é¢˜</span></summary>
                        <ul>
                            <li><a href="tags.html">æ ‡ç­¾ç®¡ç†</a></li>
                            <li><a href="tag-edit.html">æ ‡ç­¾ç¼–è¾‘</a></li>
                            <li><a href="topic-groups.html" class="active">ä¸»é¢˜ç»„</a></li>
                        </ul>
                    </details>
                </li>
                
                <li><a href="analytics.html"><span class="iconify text-red-600" data-icon="heroicons:chart-bar" data-width="18"></span><span class="sidebar-text">æ•°æ®ç»Ÿè®¡</span></a></li>
                
                <li>
                    <details>
                        <summary><span class="iconify text-gray-600" data-icon="heroicons:cog-6-tooth" data-width="18"></span><span class="sidebar-text">ç³»ç»Ÿè®¾ç½®</span></summary>
                        <ul>
                            <li><a href="settings.html">ç³»ç»Ÿæ¦‚è§ˆ</a></li>
                            <li><a href="admins.html">è´¦æˆ·ç®¡ç†</a></li>
                            <li><a href="permissions.html">æƒé™æ§åˆ¶</a></li>
                            <li><a href="api-config.html">APIé…ç½®</a></li>
                            <li><a href="logs.html">æ—¥å¿—ç‰ˆæœ¬</a></li>
                        </ul>
                    </details>
                </li>
                
                <li>
                    <details>
                        <summary><span class="iconify text-teal-600" data-icon="heroicons:question-mark-circle" data-width="18"></span><span class="sidebar-text">å¸®åŠ©ä¸­å¿ƒ</span></summary>
                        <ul>
                            <li><a href="help.html">å¸®åŠ©æ–‡æ¡£</a></li>
                            <li><a href="upload-guide.html">ä¸Šä¼ æŒ‡å—</a></li>
                            <li><a href="review-standards.html">å®¡æ ¸æ ‡å‡†</a></li>
                            <li><a href="contact.html">è”ç³»å¼€å‘è€…</a></li>
                        </ul>
                    </details>
                </li>
            </ul>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 flex flex-col">
            <!-- Header -->
            <header class="navbar bg-base-100 shadow-sm border-b border-base-300 px-6" style="height: 64px;">
                <div class="navbar-start gap-2">
                    <span class="text-xl font-semibold">ä¸»é¢˜ç»„ç®¡ç†</span>
                </div>
                
                <div class="navbar-center hidden md:flex">
                    <div class="join">
                        <input type="text" id="searchInput" placeholder="æœç´¢ä¸»é¢˜ç»„..." class="input input-bordered input-sm join-item w-80" oninput="searchTopics()">
                        <button class="btn btn-sm join-item btn-primary">
                            <span class="iconify" data-icon="heroicons:magnifying-glass" data-width="16"></span>
                        </button>
                    </div>
                </div>
                
                <div class="navbar-end gap-3">
                    <div class="indicator">
                        <span class="indicator-item badge badge-accent badge-sm">8</span>
                        <button class="btn btn-ghost btn-circle">
                            <span class="iconify" data-icon="heroicons:bell" data-width="20"></span>
                        </button>
                    </div>
                    
                    <div class="dropdown dropdown-end">
                        <div tabindex="0" role="button" class="btn btn-ghost btn-circle avatar">
                            <div class="w-10 h-10 rounded-full bg-primary flex items-center justify-center">
                                <span class="font-semibold text-white" style="font-size: 16px; line-height: 40px;">ç®¡</span>
                            </div>
                        </div>
                        <ul tabindex="0" class="menu menu-sm dropdown-content mt-3 z-50 p-2 shadow-lg bg-base-100 rounded-box w-52 border border-base-300">
                            <li class="menu-title"><span>ç®¡ç†å‘˜ä¸­å¿ƒ</span></li>
                            <li><a href="admins.html"><span class="iconify" data-icon="heroicons:user" data-width="16"></span>ä¸ªäººèµ„æ–™</a></li>
                            <li><a href="settings.html"><span class="iconify" data-icon="heroicons:cog-6-tooth" data-width="16"></span>ç³»ç»Ÿè®¾ç½®</a></li>
                            <li><a href="logs.html"><span class="iconify" data-icon="heroicons:clock" data-width="16"></span>æ“ä½œæ—¥å¿—</a></li>
                            <div class="divider my-1"></div>
                            <li><a onclick="handleLogout()" class="text-error"><span class="iconify" data-icon="heroicons:arrow-right-on-rectangle" data-width="16"></span>é€€å‡ºç™»å½•</a></li>
                        </ul>
                    </div>
                </div>
            </header>

            <!-- Breadcrumbs -->
            <div class="breadcrumbs text-xs py-2 px-6 bg-base-100 border-b border-base-300">
                <ul>
                    <li><a href="dashboard.html" class="text-base-content/70 hover:text-primary"><span class="iconify" data-icon="heroicons:home" data-width="14"></span>é¦–é¡µ</a></li>
                    <li><span class="font-medium text-base-content">ä¸»é¢˜ç»„ç®¡ç†</span></li>
                </ul>
            </div>

            <!-- Content -->
            <div class="flex-1 overflow-y-auto p-6">
                <div class="max-w-7xl mx-auto space-y-6">
                    <!-- Stats -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div class="card bg-base-100 shadow-sm">
                            <div class="card-body p-4">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <p class="text-xs text-base-content/60">ä¸»é¢˜ç»„æ€»æ•°</p>
                                        <p id="statTotalTopics" class="text-2xl font-bold">-</p>
                                    </div>
                                    <div class="w-12 h-12 bg-purple-100 rounded-lg flex items-center justify-center">
                                        <span class="iconify text-purple-600" data-icon="heroicons:folder" data-width="24"></span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="card bg-base-100 shadow-sm">
                            <div class="card-body p-4">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <p class="text-xs text-base-content/60">æ€»è®²é“æ•°</p>
                                        <p id="statTotalSermons" class="text-2xl font-bold">-</p>
                                    </div>
                                    <div class="w-12 h-12 bg-blue-100 rounded-lg flex items-center justify-center">
                                        <span class="iconify text-blue-600" data-icon="heroicons:microphone" data-width="24"></span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="card bg-base-100 shadow-sm">
                            <div class="card-body p-4">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <p class="text-xs text-base-content/60">å¹³å‡è®²é“æ•°</p>
                                        <p id="statAvgSermons" class="text-2xl font-bold">-</p>
                                    </div>
                                    <div class="w-12 h-12 bg-green-100 rounded-lg flex items-center justify-center">
                                        <span class="iconify text-green-600" data-icon="heroicons:chart-bar" data-width="24"></span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Actions Bar -->
                    <div class="flex items-center justify-between">
                        <button onclick="openCreateModal()" class="btn btn-primary btn-sm gap-2">
                            <span class="iconify" data-icon="heroicons:plus" data-width="16"></span>
                            æ–°å»ºä¸»é¢˜ç»„
                        </button>
                        <div class="flex gap-2">
                            <select class="select select-sm select-bordered" onchange="filterTopics()">
                                <option value="">å…¨éƒ¨çŠ¶æ€</option>
                                <option value="active">å·²å¯ç”¨</option>
                                <option value="inactive">å·²ç¦ç”¨</option>
                            </select>
                            <button class="btn btn-sm btn-ghost gap-2" onclick="loadTopics(currentPage)">
                                <span class="iconify" data-icon="heroicons:arrow-path" data-width="14"></span>
                                åˆ·æ–°
                            </button>
                        </div>
                    </div>

                    <!-- Topic Groups Table -->
                    <div class="card bg-base-100 shadow-sm">
                        <div class="card-body p-0">
                            <div class="overflow-x-auto">
                                <table class="table table-sm">
                                    <thead>
                                        <tr class="border-b border-base-300">
                                            <th>ä¸»é¢˜ç»„åç§°</th>
                                            <th>æè¿°</th>
                                            <th class="text-center">è®²é“æ•°é‡</th>
                                            <th class="text-center">åˆ›å»ºæ—¶é—´</th>
                                            <th class="text-center">çŠ¶æ€</th>
                                            <th class="text-center">æ“ä½œ</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <td colspan="6" class="text-center py-8 text-base-content/70">
                                                åŠ è½½ä¸­...
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>

                            <!-- Pagination -->
                            <div class="flex items-center justify-between p-4 border-t border-base-300">
                                <div class="text-sm text-base-content/60">
                                    æ˜¾ç¤º 1-5 / å…± 28 æ¡
                                </div>
                                <div class="flex items-center gap-2">
                                    <div class="join">
                                        <button class="join-item btn btn-sm">Â«</button>
                                        <button class="join-item btn btn-sm btn-active">1</button>
                                        <button class="join-item btn btn-sm">2</button>
                                        <button class="join-item btn btn-sm">3</button>
                                        <button class="join-item btn btn-sm">Â»</button>
                                    </div>
                                    <select class="select select-bordered select-sm" onchange="pageSize = parseInt(this.value); currentPage = 1; renderTopics()">
                                        <option value="10" selected>10æ¡/é¡µ</option>
                                        <option value="20">20æ¡/é¡µ</option>
                                        <option value="50">50æ¡/é¡µ</option>
                                        <option value="100">100æ¡/é¡µ</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Edit Topic Modal -->
    <dialog id="edit-topic-modal" class="modal">
        <div class="modal-box w-11/12 max-w-5xl">
            <div class="flex items-center justify-between mb-6">
                <h3 class="font-bold text-xl" id="modal-title">ç¼–è¾‘ä¸»é¢˜ç»„ - åœ£ç»æ¦‚è§ˆ</h3>
                <form method="dialog">
                    <button class="btn btn-sm btn-circle btn-ghost">
                        <span class="iconify" data-icon="heroicons:x-mark" data-width="20"></span>
                    </button>
                </form>
            </div>

            <!-- Topic Info Section -->
            <div class="card bg-base-200 mb-6">
                <div class="card-body p-4">
                    <!-- Description -->
                    <div class="form-control mb-4">
                        <label class="label">
                            <span class="label-text font-medium">ä¸»é¢˜æè¿°</span>
                        </label>
                        <textarea id="topic-description" class="textarea textarea-bordered" rows="2" placeholder="ç®€è¦æè¿°è¿™ä¸ªä¸»é¢˜çš„å†…å®¹å’Œç›®çš„..."></textarea>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <!-- Topic Icon -->
                        <div class="form-control">
                            <label class="label">
                                <span class="label-text font-medium">ä¸»é¢˜å›¾æ ‡</span>
                            </label>
                            <div class="flex items-center gap-3">
                                <div id="topic-icon-preview" class="w-16 h-16 bg-gradient-to-br from-purple-500 to-pink-500 rounded-lg flex items-center justify-center cursor-pointer" onclick="document.getElementById('icon-upload').click()">
                                    <span class="iconify text-white" data-icon="heroicons:book-open" data-width="32"></span>
                                </div>
                                <div class="flex-1">
                                    <input type="file" id="icon-upload" class="file-input file-input-bordered file-input-sm w-full" accept="image/*" onchange="previewIcon(this)" style="display: none;">
                                    <button class="btn btn-sm btn-outline w-full" onclick="document.getElementById('icon-upload').click()">
                                        <span class="iconify" data-icon="heroicons:photo" data-width="16"></span>
                                        æ›´æ¢å›¾æ ‡
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Topic Status -->
                        <div class="form-control">
                            <label class="label">
                                <span class="label-text font-medium">çŠ¶æ€</span>
                            </label>
                            <select id="topic-status" class="select select-bordered select-sm">
                                <option value="active">å·²å¯ç”¨</option>
                                <option value="inactive">å·²ç¦ç”¨</option>
                            </select>
                        </div>

                        <!-- Delete Button -->
                        <div class="form-control" id="delete-topic-section">
                            <label class="label">
                                <span class="label-text font-medium">å±é™©æ“ä½œ</span>
                            </label>
                            <button onclick="deleteTopic()" class="btn btn-error btn-sm gap-2">
                                <span class="iconify" data-icon="heroicons:trash" data-width="16"></span>
                                åˆ é™¤ä¸»é¢˜ç»„
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Sermons List in Topic -->
            <div class="mb-6">
                <div class="flex items-center justify-between mb-4">
                    <h4 class="font-semibold">ä¸»é¢˜ç»„è®²é“åˆ—è¡¨ <span class="badge badge-primary" id="sermon-count">66ç¯‡</span></h4>
                    <div class="flex gap-2">
                        <input type="text" placeholder="æœç´¢è®²é“..." class="input input-sm input-bordered w-64" id="modal-search" oninput="searchModalSermons()">
                        <button class="btn btn-sm btn-primary gap-2" onclick="openAddSermonModal()">
                            <span class="iconify" data-icon="heroicons:plus" data-width="14"></span>
                            æ·»åŠ è®²é“
                        </button>
                    </div>
                </div>

                <div class="overflow-x-auto max-h-96">
                    <table class="table table-sm">
                        <thead class="sticky top-0 bg-base-200">
                            <tr>
                                <th class="w-12">
                                    <input type="checkbox" class="checkbox checkbox-sm" onchange="toggleSelectAll(this)">
                                </th>
                                <th>è®²é“æ ‡é¢˜</th>
                                <th>è®²å‘˜</th>
                                <th>æ—¶é•¿</th>
                                <th>çŠ¶æ€</th>
                                <th class="text-center">æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody id="sermons-table-body">
                            <tr>
                                <td colspan="6" class="text-center py-8 text-base-content/70">
                                    åŠ è½½ä¸­...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                
                <!-- Modal Sermon Pagination -->
                <div class="flex items-center justify-between mt-4 pb-2 border-t border-base-200 pt-4">
                    <div class="text-sm text-base-content/60" id="modal-sermon-pagination-info">
                        æ˜¾ç¤º 1-10 / å…± 0 æ¡
                    </div>
                    <div class="flex items-center gap-2">
                        <div class="join" id="modal-sermon-pagination-buttons">
                            <button class="join-item btn btn-sm" disabled>Â«</button>
                            <button class="join-item btn btn-sm btn-active">1</button>
                            <button class="join-item btn btn-sm" disabled>Â»</button>
                        </div>
                        <select class="select select-bordered select-sm" onchange="modalSermonPageSize = parseInt(this.value); modalSermonPage = 1; renderTopicSermons(allModalSermons)">
                            <option value="10" selected>10æ¡/é¡µ</option>
                            <option value="20">20æ¡/é¡µ</option>
                            <option value="50">50æ¡/é¡µ</option>
                            <option value="100">100æ¡/é¡µ</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Batch Actions -->
            <div class="flex items-center gap-2 mb-4">
                <span class="text-sm text-base-content/70">å·²é€‰æ‹© <span id="selected-count">0</span> ç¯‡</span>
                <button class="btn btn-xs btn-error gap-1" onclick="batchRemove()">
                    <span class="iconify" data-icon="heroicons:trash" data-width="12"></span>
                    æ‰¹é‡ç§»é™¤
                </button>
            </div>

            <!-- Action Buttons -->
            <div class="modal-action">
                <form method="dialog" class="flex gap-2">
                    <button class="btn btn-ghost">å–æ¶ˆ</button>
                    <button type="button" onclick="saveTopicChanges()" class="btn btn-primary gap-2">
                        <span class="iconify" data-icon="heroicons:check" data-width="16"></span>
                        ä¿å­˜æ›´æ”¹
                    </button>
                </form>
            </div>
        </div>
        <form method="dialog" class="modal-backdrop">
            <button>close</button>
        </form>
    </dialog>

    <!-- Add Sermon Modal -->
    <dialog id="add-sermon-modal" class="modal">
        <div class="modal-box w-11/12 max-w-4xl">
            <div class="flex items-center justify-between mb-6">
                <h3 class="font-bold text-lg">æ·»åŠ è®²é“åˆ°ä¸»é¢˜ç»„</h3>
                <form method="dialog">
                    <button class="btn btn-sm btn-circle btn-ghost">
                        <span class="iconify" data-icon="heroicons:x-mark" data-width="20"></span>
                    </button>
                </form>
            </div>

            <!-- Search and Filter -->
            <div class="flex gap-2 mb-4">
                <input type="text" placeholder="æœç´¢è®²é“æ ‡é¢˜ã€è®²å‘˜..." class="input input-bordered input-sm flex-1" id="add-sermon-search" oninput="searchAvailableSermons()">
                <select class="select select-bordered select-sm" id="sermon-filter">
                    <option value="">å…¨éƒ¨çŠ¶æ€</option>
                    <option value="published">å·²å‘å¸ƒ</option>
                    <option value="pending">å¾…å®¡æ ¸</option>
                </select>
            </div>

            <!-- Available Sermons List -->
            <div class="overflow-x-auto max-h-96 mb-4">
                <table class="table table-sm">
                    <thead class="sticky top-0 bg-base-200">
                        <tr>
                            <th class="w-12">
                                <input type="checkbox" class="checkbox checkbox-sm" onchange="toggleSelectAllAvailable(this)">
                            </th>
                            <th>è®²é“æ ‡é¢˜</th>
                            <th>è®²å‘˜</th>
                            <th>ä¸Šä¼ æ—¶é—´</th>
                            <th>çŠ¶æ€</th>
                        </tr>
                    </thead>
                    <tbody id="available-sermons-body">
                        <tr>
                            <td colspan="5" class="text-center py-8 text-base-content/70">
                                åŠ è½½ä¸­...
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <div class="text-sm text-base-content/70 mb-4">
                å·²é€‰æ‹© <span id="add-selected-count">0</span> ç¯‡è®²é“
            </div>

            <!-- Action Buttons -->
            <div class="modal-action">
                <form method="dialog" class="flex gap-2">
                    <button class="btn btn-ghost">å–æ¶ˆ</button>
                    <button type="button" onclick="confirmAddSermons()" class="btn btn-primary gap-2">
                        <span class="iconify" data-icon="heroicons:plus" data-width="16"></span>
                        æ·»åŠ é€‰ä¸­çš„è®²é“
                    </button>
                </form>
            </div>
        </div>
        <form method="dialog" class="modal-backdrop">
            <button>close</button>
        </form>
    </dialog>

    <!-- Create Topic Modal -->
    <dialog id="create-topic-modal" class="modal">
        <div class="modal-box">
            <div class="flex items-center justify-between mb-6">
                <h3 class="font-bold text-lg">æ–°å»ºä¸»é¢˜ç»„</h3>
                <form method="dialog">
                    <button class="btn btn-sm btn-circle btn-ghost">
                        <span class="iconify" data-icon="heroicons:x-mark" data-width="20"></span>
                    </button>
                </form>
            </div>

            <div class="space-y-4">
                <!-- Topic Name -->
                <div class="form-control">
                    <label class="label">
                        <span class="label-text font-medium">ä¸»é¢˜ç»„åç§° <span class="text-error">*</span></span>
                    </label>
                    <input type="text" id="new-topic-name" class="input input-bordered" placeholder="ä¾‹å¦‚ï¼šç¦éŸ³ä¹¦è®²è§£">
                </div>

                <!-- Topic Description -->
                <div class="form-control">
                    <label class="label">
                        <span class="label-text font-medium">æè¿°</span>
                    </label>
                    <textarea id="new-topic-description" class="textarea textarea-bordered" rows="3" placeholder="ç®€è¦æè¿°è¿™ä¸ªä¸»é¢˜ç»„..."></textarea>
                </div>

                <!-- Topic Icon -->
                <div class="form-control">
                    <label class="label">
                        <span class="label-text font-medium">ä¸»é¢˜å›¾æ ‡</span>
                    </label>
                    <input type="file" id="new-topic-icon" class="file-input file-input-bordered" accept="image/*">
                    <label class="label">
                        <span class="label-text-alt">æ¨èå›¾ç‰‡æ¯”ä¾‹ 3:2ï¼ˆä¾‹å¦‚ 1536Ã—1024ï¼‰</span>
                    </label>
                </div>

                <!-- Topic Status -->
                <div class="form-control">
                    <label class="label">
                        <span class="label-text font-medium">çŠ¶æ€</span>
                    </label>
                    <select id="new-topic-status" class="select select-bordered">
                        <option value="active">å·²å¯ç”¨</option>
                        <option value="inactive">å·²ç¦ç”¨</option>
                    </select>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="modal-action">
                <form method="dialog" class="flex gap-2">
                    <button class="btn btn-ghost">å–æ¶ˆ</button>
                    <button type="button" onclick="createTopic()" class="btn btn-primary gap-2">
                        <span class="iconify" data-icon="heroicons:check" data-width="16"></span>
                        åˆ›å»ºä¸»é¢˜ç»„
                    </button>
                </form>
            </div>
        </div>
        <form method="dialog" class="modal-backdrop">
            <button>close</button>
        </form>
    </dialog>

    <script>
        let currentTopic = null;
        let allTopics = [];
        let currentPage = 1;
        let pageSize = 10;
        let modalSermonPage = 1;
        let modalSermonPageSize = 10;
        let allModalSermons = [];

        function handleLogout() {
            localStorage.removeItem('admin_token');
            localStorage.removeItem('admin_username');
            window.location.href = 'login.html';
        }

        // Update statistics
        async function updateStats() {
            try {
                // Get all topics
                const topicsResponse = await fetch(`${APIConfig.baseURL}${APIConfig.apiVersion}/topics?_limit=1000`, {
                    headers: {
                        'X-API-Key': APIConfig.apiKey,
                        'X-Client-Type': APIConfig.clientType
                    }
                });
                const topicsData = await topicsResponse.json();
                const topics = topicsData.data || topicsData;
                
                // Calculate total topics
                const totalTopics = topics.length;
                
                // Calculate total sermons across all topics
                let totalSermons = 0;
                for (const topic of topics) {
                    totalSermons += topic.sermon_count || 0;
                }
                
                // Calculate average sermons per topic
                const avgSermons = totalTopics > 0 ? Math.round(totalSermons / totalTopics) : 0;
                
                // Update UI
                document.getElementById('statTotalTopics').textContent = totalTopics;
                document.getElementById('statTotalSermons').textContent = totalSermons.toLocaleString();
                document.getElementById('statAvgSermons').textContent = avgSermons;
            } catch (error) {
                console.error('Failed to load stats:', error);
                document.getElementById('statTotalTopics').textContent = '-';
                document.getElementById('statTotalSermons').textContent = '-';
                document.getElementById('statAvgSermons').textContent = '-';
            }
        }

        // Load topics from API
        async function loadTopics(page = 1) {
            try {
                const response = await fetch(`${APIConfig.baseURL}${APIConfig.apiVersion}/topics?_limit=1000`, {
                    headers: {
                        'X-API-Key': APIConfig.apiKey,
                        'X-Client-Type': APIConfig.clientType
                    }
                });
                const data = await response.json();
                let apiTopics = data.data || data;
                
                // Load deleted system topics from localStorage
                const deletedSystemTopics = JSON.parse(localStorage.getItem('deletedSystemTopics') || '[]');
                console.log('Deleted system topics:', deletedSystemTopics);
                
                // Filter out deleted system topics
                apiTopics = apiTopics.filter(topic => !deletedSystemTopics.includes(topic.id));
                
                // Load custom topics from localStorage
                const customTopics = JSON.parse(localStorage.getItem('customTopics') || '[]');
                allTopics = [...apiTopics, ...customTopics];
                
                console.log('All topics after filtering:', allTopics.length);
                
                currentPage = page;
                renderTopics();
            } catch (error) {
                console.error('Failed to load topics:', error);
                alert('åŠ è½½ä¸»é¢˜ç»„å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
            }
        }

        function renderTopics() {
            const tbody = document.querySelector('tbody');
            
            // Apply filters
            let filteredTopics = [...allTopics];
            
            // Search filter
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            if (searchTerm) {
                filteredTopics = filteredTopics.filter(topic => 
                    topic.name.toLowerCase().includes(searchTerm) || 
                    topic.description.toLowerCase().includes(searchTerm)
                );
            }
            
            // Status filter
            const statusFilter = document.querySelector('select[onchange="filterTopics()"]').value;
            if (statusFilter) {
                filteredTopics = filteredTopics.filter(topic => topic.status === statusFilter);
            }
            
            // Pagination
            const totalPages = Math.ceil(filteredTopics.length / pageSize);
            const startIndex = (currentPage - 1) * pageSize;
            const endIndex = startIndex + pageSize;
            const paginatedTopics = filteredTopics.slice(startIndex, endIndex);
            
            // Render table
            if (paginatedTopics.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" class="text-center py-8 text-base-content/70">
                            æš‚æ— ä¸»é¢˜ç»„æ•°æ®
                        </td>
                    </tr>
                `;
            } else {
                tbody.innerHTML = paginatedTopics.map(topic => {
                    const statusBadge = topic.status === 'active' 
                        ? '<span class="badge badge-success badge-sm">å·²å¯ç”¨</span>'
                        : '<span class="badge badge-warning badge-sm">å·²ç¦ç”¨</span>';
                    
                    return `
                        <tr class="hover border-b border-base-300">
                            <td>
                                <span class="font-medium">${topic.name}</span>
                            </td>
                            <td class="text-sm text-base-content/70">${topic.description || ''}</td>
                            <td class="text-center"><span class="badge badge-lg">${topic.sermon_count || 0}</span></td>
                            <td class="text-center text-sm">${new Date(topic.created_at).toLocaleDateString('zh-CN')}</td>
                            <td class="text-center">${statusBadge}</td>
                            <td class="text-center">
                                <button class="btn btn-ghost btn-xs gap-1 edit-topic-btn" data-topic-id="${topic.id}" data-topic-name="${topic.name}" data-sermon-count="${topic.sermon_count || 0}">
                                    <span class="iconify" data-icon="heroicons:pencil" data-width="14"></span>
                                    ç¼–è¾‘
                                </button>
                            </td>
                        </tr>
                    `;
                }).join('');
            }
            
            // Update stats
            updateStats();
            
            // Update pagination
            renderPagination(filteredTopics.length, totalPages);
        }

        function getTopicGradient(topicId) {
            const gradients = {
                'topic-faith': 'bg-gradient-to-br from-purple-500 to-pink-500',
                'topic-prayer': 'bg-gradient-to-br from-blue-500 to-cyan-500',
                'topic-christian-life': 'bg-gradient-to-br from-green-500 to-emerald-500',
                'topic-spiritual-growth': 'bg-gradient-to-br from-orange-500 to-red-500',
                'topic-worship': 'bg-gradient-to-br from-indigo-500 to-purple-500',
                'topic-bible-study': 'bg-gradient-to-br from-yellow-500 to-orange-500',
                'topic-evangelism': 'bg-gradient-to-br from-red-500 to-pink-500',
                'topic-discipleship': 'bg-gradient-to-br from-teal-500 to-green-500'
            };
            return gradients[topicId] || 'bg-gradient-to-br from-gray-500 to-slate-500';
        }

        function getTopicIcon(topicId) {
            const icons = {
                'topic-faith': 'star',
                'topic-prayer': 'hand-raised',
                'topic-christian-life': 'user-group',
                'topic-spiritual-growth': 'fire',
                'topic-worship': 'musical-note',
                'topic-bible-study': 'book-open',
                'topic-evangelism': 'megaphone',
                'topic-discipleship': 'academic-cap'
            };
            return icons[topicId] || 'folder';
        }

        function updateStats() {
            const totalTopics = allTopics.length;
            const totalSermons = allTopics.reduce((sum, topic) => sum + topic.sermon_count, 0);
            const avgSermons = totalTopics > 0 ? Math.round(totalSermons / totalTopics) : 0;
            
            document.querySelector('.grid .card:nth-child(1) .text-2xl').textContent = totalTopics;
            document.querySelector('.grid .card:nth-child(2) .text-2xl').textContent = totalSermons.toLocaleString();
            document.querySelector('.grid .card:nth-child(3) .text-2xl').textContent = avgSermons;
        }

        function renderPagination(totalItems, totalPages) {
            const paginationInfo = document.querySelector('.flex.items-center.justify-between.p-4 .text-sm');
            const paginationButtons = document.querySelector('.flex.items-center.justify-between.p-4 .join');
            
            const startIndex = (currentPage - 1) * pageSize + 1;
            const endIndex = Math.min(currentPage * pageSize, totalItems);
            
            paginationInfo.textContent = `æ˜¾ç¤º ${startIndex}-${endIndex} / å…± ${totalItems} æ¡`;
            
            // Generate pagination buttons
            let buttonsHTML = `<button class="join-item btn btn-sm" ${currentPage === 1 ? 'disabled' : ''} onclick="loadTopics(${currentPage - 1})">Â«</button>`;
            
            for (let i = 1; i <= totalPages; i++) {
                if (i === 1 || i === totalPages || (i >= currentPage - 1 && i <= currentPage + 1)) {
                    buttonsHTML += `<button class="join-item btn btn-sm ${i === currentPage ? 'btn-active' : ''}" onclick="loadTopics(${i})">${i}</button>`;
                } else if (i === currentPage - 2 || i === currentPage + 2) {
                    buttonsHTML += `<button class="join-item btn btn-sm btn-disabled">...</button>`;
                }
            }
            
            buttonsHTML += `<button class="join-item btn btn-sm" ${currentPage === totalPages ? 'disabled' : ''} onclick="loadTopics(${currentPage + 1})">Â»</button>`;
            
            paginationButtons.innerHTML = buttonsHTML;
        }

        function searchTopics() {
            currentPage = 1;
            renderTopics();
        }

        function filterTopics() {
            currentPage = 1;
            renderTopics();
        }

        async function openEditModal(topicId, topicName, sermonCount) {
            try {
                // Fetch topic data from API
                const response = await fetch(`${APIConfig.baseURL}${APIConfig.apiVersion}/topics/${topicId}`, {
                    headers: {
                        'X-API-Key': APIConfig.apiKey,
                        'X-Client-Type': APIConfig.clientType
                    }
                });
                if (!response.ok) {
                    throw new Error('Failed to load topic data');
                }
                const result = await response.json();
                currentTopic = result.data || result;
                
                if (!currentTopic) {
                    alert('ä¸»é¢˜ç»„ä¸å­˜åœ¨');
                    return;
                }
                
                document.getElementById('modal-title').textContent = `ç¼–è¾‘ä¸»é¢˜ç»„ - ${currentTopic.name}`;
                document.getElementById('sermon-count').textContent = `${currentTopic.sermon_count || 0}ç¯‡`;
                document.getElementById('topic-status').value = currentTopic.status || 'active';
                document.getElementById('topic-description').value = currentTopic.description || '';
                
                // Reset icon preview and uploaded data
                uploadedIconData = null;
                const iconPreview = document.getElementById('topic-icon-preview');
                
                // Set icon preview based on current topic's cover_image_url
                if (currentTopic.cover_image_url) {
                    // Real image URL from R2 or external source
                    iconPreview.style.backgroundImage = `url(${currentTopic.cover_image_url})`;
                    iconPreview.style.backgroundSize = 'cover';
                    iconPreview.style.backgroundPosition = 'center';
                    iconPreview.innerHTML = '';
                    iconPreview.className = 'w-16 h-16 rounded-lg flex items-center justify-center cursor-pointer';
                } else {
                    // Default gradient icon
                    const gradient = getTopicGradient(currentTopic.id);
                    const iconName = getTopicIcon(currentTopic.id);
                    iconPreview.className = `w-16 h-16 ${gradient} rounded-lg flex items-center justify-center cursor-pointer`;
                    iconPreview.style.backgroundImage = '';
                    iconPreview.innerHTML = `<span class="iconify text-white" data-icon="heroicons:${iconName}" data-width="32"></span>`;
                }
            } catch (error) {
                console.error('Failed to load topic:', error);
                alert('åŠ è½½ä¸»é¢˜æ•°æ®å¤±è´¥ï¼Œè¯·é‡è¯•');
                return;
            }
            
            // Reset file input
            document.getElementById('icon-upload').value = '';
            
            // Always show delete button for all topics
            const deleteSection = document.getElementById('delete-topic-section');
            console.log('Delete section element:', deleteSection);
            console.log('Current topic ID:', currentTopic.id);
            console.log('Is custom topic?', currentTopic.id.startsWith('topic-1'));
            
            if (deleteSection) {
                // Show delete button for all topics (both custom and system)
                deleteSection.style.display = 'block';
                console.log('âœ… Showing delete button');
            } else {
                console.error('âŒ Delete section element not found!');
            }
            
            // Load sermons for this topic
            await loadTopicSermons(topicId);
            
            document.getElementById('edit-topic-modal').showModal();
        }
        
        async function loadTopicSermons(topicId) {
            try {
                console.log('ğŸ“¡ Loading sermons for topic:', topicId);
                
                // Reset modal sermon pagination
                modalSermonPage = 1;
                
                // ç›´æ¥ä» API è·å–è¯¥ä¸»é¢˜çš„è®²é“åˆ—è¡¨
                const response = await fetch(`${APIConfig.baseURL}${APIConfig.apiVersion}/topics/${topicId}/sermons?_limit=10000`, {
                    headers: {
                        'X-API-Key': APIConfig.apiKey,
                        'X-Client-Type': APIConfig.clientType
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`API returned ${response.status}`);
                }
                
                const data = await response.json();
                allModalSermons = data.data || data;
                
                console.log('âœ… Loaded sermons from API:', allModalSermons.length);
                
                // Update topic's sermon count cache
                if (currentTopic) {
                    currentTopic.topic_sermons_cache = allModalSermons.length;
                    
                    // Update in allTopics array
                    const topicIndex = allTopics.findIndex(t => t.id === currentTopic.id);
                    if (topicIndex !== -1) {
                        allTopics[topicIndex].topic_sermons_cache = allModalSermons.length;
                    }
                }
                
                // Render sermons table with pagination
                renderTopicSermons(allModalSermons);
            } catch (error) {
                console.error('Failed to load topic sermons:', error);
                document.getElementById('sermons-table-body').innerHTML = `
                    <tr>
                        <td colspan="6" class="text-center py-8 text-base-content/70">
                            åŠ è½½è®²é“å¤±è´¥: ${error.message}
                        </td>
                    </tr>
                `;
            }
        }
        
        function renderTopicSermons(sermons) {
            const tbody = document.getElementById('sermons-table-body');
            
            if (sermons.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" class="text-center py-8 text-base-content/70">
                            è¯¥ä¸»é¢˜ç»„æš‚æ— è®²é“
                        </td>
                    </tr>
                `;
                document.getElementById('sermon-count').textContent = '0ç¯‡';
                // Update pagination info
                document.getElementById('modal-sermon-pagination-info').textContent = 'æ˜¾ç¤º 0 / å…± 0 æ¡';
                return;
            }
            
            // Client-side pagination
            const total = sermons.length;
            const totalPages = Math.ceil(total / modalSermonPageSize);
            const startIndex = (modalSermonPage - 1) * modalSermonPageSize;
            const endIndex = startIndex + modalSermonPageSize;
            const paginatedSermons = sermons.slice(startIndex, endIndex);
            
            tbody.innerHTML = paginatedSermons.map(sermon => {
                const duration = sermon.duration ? `${Math.floor(sermon.duration / 60)}:${(sermon.duration % 60).toString().padStart(2, '0')}` : '--:--';
                
                // Normalize status to Chinese
                let displayStatus = sermon.status;
                if (sermon.status === 'published') {
                    displayStatus = 'å·²å‘å¸ƒ';
                } else if (sermon.status === 'pending') {
                    displayStatus = 'å¾…å®¡æ ¸';
                } else if (sermon.status === 'rejected') {
                    displayStatus = 'å·²æ‹’ç»';
                }
                
                const statusBadge = displayStatus === 'å·²å‘å¸ƒ' ? 'badge-success' : 'badge-warning';
                
                return `
                    <tr class="hover">
                        <td><input type="checkbox" class="checkbox checkbox-sm sermon-checkbox" data-id="${sermon.id}"></td>
                        <td>
                            <div class="flex items-center gap-2">
                                <span class="font-medium">${sermon.title}</span>
                            </div>
                        </td>
                        <td>${sermon.speaker?.name || 'æœªçŸ¥è®²å‘˜'}</td>
                        <td>${duration}</td>
                        <td><span class="badge ${statusBadge} badge-sm">${displayStatus}</span></td>
                        <td class="text-center">
                            <button class="btn btn-ghost btn-xs text-error" onclick="removeSermonFromTopic('${sermon.id}')">
                                <span class="iconify" data-icon="heroicons:trash" data-width="14"></span>
                                ç§»é™¤
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
            
            document.getElementById('sermon-count').textContent = `${total}ç¯‡`;
            
            // Render pagination
            renderModalSermonPagination(total, totalPages);
        }
        
        function renderModalSermonPagination(total, totalPages) {
            const start = (modalSermonPage - 1) * modalSermonPageSize + 1;
            const end = Math.min(modalSermonPage * modalSermonPageSize, total);
            
            // Update pagination info
            const paginationInfo = document.getElementById('modal-sermon-pagination-info');
            if (paginationInfo) {
                paginationInfo.textContent = `æ˜¾ç¤º ${start}-${end} / å…± ${total} æ¡`;
            }
            
            // Update pagination buttons
            const paginationButtons = document.getElementById('modal-sermon-pagination-buttons');
            if (paginationButtons) {
                let buttonsHTML = `
                    <button class="join-item btn btn-sm" ${modalSermonPage === 1 ? 'disabled' : ''} 
                        onclick="modalSermonPage = ${modalSermonPage - 1}; renderTopicSermons(allModalSermons)">Â«</button>
                `;
                
                for (let i = 1; i <= totalPages; i++) {
                    if (i === 1 || i === totalPages || (i >= modalSermonPage - 1 && i <= modalSermonPage + 1)) {
                        buttonsHTML += `
                            <button class="join-item btn btn-sm ${i === modalSermonPage ? 'btn-active' : ''}" 
                                onclick="modalSermonPage = ${i}; renderTopicSermons(allModalSermons)">${i}</button>
                        `;
                    } else if (i === modalSermonPage - 2 || i === modalSermonPage + 2) {
                        buttonsHTML += `<button class="join-item btn btn-sm btn-disabled">...</button>`;
                    }
                }
                
                buttonsHTML += `
                    <button class="join-item btn btn-sm" ${modalSermonPage === totalPages || totalPages === 0 ? 'disabled' : ''} 
                        onclick="modalSermonPage = ${modalSermonPage + 1}; renderTopicSermons(allModalSermons)">Â»</button>
                `;
                
                paginationButtons.innerHTML = buttonsHTML;
            }
        }

        let uploadedIconData = null;
        
        async function previewIcon(input) {
            if (input.files && input.files[0]) {
                const file = input.files[0];
                
                // Preview the image immediately
                const reader = new FileReader();
                reader.onload = function(e) {
                    const preview = document.getElementById('topic-icon-preview');
                    preview.style.backgroundImage = `url(${e.target.result})`;
                    preview.style.backgroundSize = 'cover';
                    preview.style.backgroundPosition = 'center';
                    preview.innerHTML = '';
                    preview.className = 'w-16 h-16 rounded-lg flex items-center justify-center cursor-pointer';
                };
                reader.readAsDataURL(file);
                
                // Upload to R2
                try {
                    const formData = new FormData();
                    formData.append('file', file);  // ä¿®æ”¹ä¸º 'file' ä»¥åŒ¹é…åç«¯ API
                    formData.append('type', 'topic');  // æŒ‡å®šç±»å‹
                    
                    const uploadResponse = await fetch(`${APIConfig.baseURL}${APIConfig.apiVersion}/upload/image`, {
                        method: 'POST',
                        headers: {
                            'X-API-Key': APIConfig.apiKey,
                            'X-Client-Type': APIConfig.clientType
                        },
                        body: formData
                    });
                    
                    if (!uploadResponse.ok) {
                        const errorData = await uploadResponse.json();
                        throw new Error(errorData.error?.message || 'Upload failed');
                    }
                    
                    const uploadResult = await uploadResponse.json();
                    uploadedIconData = uploadResult.data?.url || uploadResult.url;
                    
                    console.log('Icon uploaded to R2:', uploadedIconData);
                } catch (error) {
                    console.error('Failed to upload icon:', error);
                    alert('å›¾æ ‡ä¸Šä¼ å¤±è´¥ï¼š' + error.message);
                    uploadedIconData = null;
                }
            }
        }

        async function deleteTopic() {
            if (!currentTopic) return;
            
            const topicName = currentTopic.name;
            const isCustomTopic = currentTopic.id.startsWith('topic-1');
            const topicType = isCustomTopic ? 'è‡ªå®šä¹‰ä¸»é¢˜ç»„' : 'ç³»ç»Ÿä¸»é¢˜ç»„';
            
            if (confirm(`ç¡®å®šè¦åˆ é™¤${topicType}"${topicName}"å—ï¼Ÿ\n\nä¸»é¢˜ç»„å†…çš„è®²é“ä¸ä¼šè¢«åˆ é™¤ï¼Œåªæ˜¯è§£é™¤å…³è”ã€‚`)) {
                try {
                    // Call API to delete topic
                    const response = await fetch(`${APIConfig.baseURL}${APIConfig.apiVersion}/topics/${currentTopic.id}`, {
                        method: 'DELETE',
                        headers: {
                            'X-API-Key': APIConfig.apiKey,
                            'X-Client-Type': APIConfig.clientType
                        }
                    });
                    
                    const result = await response.json();
                    
                    if (!response.ok || !result.success) {
                        throw new Error(result.error?.message || 'åˆ é™¤å¤±è´¥');
                    }
                    
                    console.log('âœ… Topic deleted via API:', result.data);
                    
                    // Reload all topics from API
                    await loadTopics(currentPage);
                    
                    alert(`${topicType}"${topicName}"å·²åˆ é™¤ã€‚è®²é“æœªè¢«åˆ é™¤ï¼Œåªæ˜¯è§£é™¤äº†å…³è”ã€‚`);
                    document.getElementById('edit-topic-modal').close();
                } catch (error) {
                    console.error('Failed to delete topic:', error);
                    alert(`åˆ é™¤å¤±è´¥ï¼š${error.message}`);
                }
            }
        }

        function searchModalSermons() {
            const searchTerm = document.getElementById('modal-search').value.toLowerCase().trim();
            
            if (!searchTerm) {
                // No search term, show all sermons with pagination
                modalSermonPage = 1;
                renderTopicSermons(allModalSermons);
                return;
            }
            
            // Filter sermons by search term
            const filteredSermons = allModalSermons.filter(sermon => {
                const title = sermon.title?.toLowerCase() || '';
                const speaker = sermon.speaker?.name?.toLowerCase() || '';
                return title.includes(searchTerm) || speaker.includes(searchTerm);
            });
            
            // Reset to page 1 and render filtered sermons
            modalSermonPage = 1;
            renderTopicSermons(filteredSermons);
        }

        function toggleSelectAll(checkbox) {
            const checkboxes = document.querySelectorAll('.sermon-checkbox');
            checkboxes.forEach(cb => {
                if (cb.closest('tr').style.display !== 'none') {
                    cb.checked = checkbox.checked;
                }
            });
            updateSelectedCount();
        }

        function updateSelectedCount() {
            const checkboxes = document.querySelectorAll('.sermon-checkbox:checked');
            document.getElementById('selected-count').textContent = checkboxes.length;
        }

        // Update count when individual checkbox is clicked
        document.addEventListener('change', (e) => {
            if (e.target.classList.contains('sermon-checkbox')) {
                updateSelectedCount();
            }
            if (e.target.classList.contains('available-sermon-checkbox')) {
                updateAddSelectedCount();
            }
        });

        function removeSermon(button) {
            if (confirm('ç¡®å®šè¦ä»ä¸»é¢˜ç»„ä¸­ç§»é™¤è¿™ç¯‡è®²é“å—ï¼Ÿ')) {
                const row = button.closest('tr');
                row.remove();
                updateSermonCount();
                alert('è®²é“å·²ç§»é™¤');
            }
        }

        function batchRemove() {
            const checkboxes = document.querySelectorAll('.sermon-checkbox:checked');
            if (checkboxes.length === 0) {
                alert('è¯·é€‰æ‹©è¦ç§»é™¤çš„è®²é“');
                return;
            }
            
            if (confirm(`ç¡®å®šè¦ç§»é™¤é€‰ä¸­çš„ ${checkboxes.length} ç¯‡è®²é“å—ï¼Ÿ`)) {
                checkboxes.forEach(checkbox => {
                    checkbox.closest('tr').remove();
                });
                
                // æ›´æ–°æ˜¾ç¤ºçš„è®²é“æ•°é‡ï¼ˆå®é™…ä¿å­˜ä¼šåœ¨ç‚¹å‡»"ä¿å­˜æ›´æ”¹"æ—¶é€šè¿‡ API å®Œæˆï¼‰
                updateSermonCount();
                updateSelectedCount();
                alert('é€‰ä¸­çš„è®²é“å·²ç§»é™¤ï¼ˆè¯·ç‚¹å‡»"ä¿å­˜æ›´æ”¹"ä»¥ä¿å­˜åˆ°æ•°æ®åº“ï¼‰');
            }
        }

        function updateSermonCount() {
            const visibleRows = document.querySelectorAll('#sermons-table-body tr:not([style*="display: none"])');
            document.getElementById('sermon-count').textContent = `${visibleRows.length}ç¯‡`;
        }

        async function saveTopicChanges() {
            if (!currentTopic) return;
            
            const status = document.getElementById('topic-status').value;
            const description = document.getElementById('topic-description').value.trim();
            
            // Update topic status and description
            currentTopic.status = status;
            currentTopic.description = description;
            currentTopic.updated_at = new Date().toISOString();
            
            // Update icon if uploaded
            if (uploadedIconData) {
                currentTopic.cover_image_url = uploadedIconData;
                uploadedIconData = null; // Reset after saving
            }
            
            // Get current sermon list
            const tbody = document.getElementById('sermons-table-body');
            const checkboxes = tbody.querySelectorAll('input[data-id]');
            const sermon_ids = Array.from(checkboxes).map(cb => cb.getAttribute('data-id'));
            
            try {
                // Call API to update topic
                const response = await fetch(`${APIConfig.baseURL}${APIConfig.apiVersion}/topics/${currentTopic.id}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-API-Key': APIConfig.apiKey,
                        'X-Client-Type': APIConfig.clientType
                    },
                    body: JSON.stringify(currentTopic)
                });
                
                const result = await response.json();
                
                if (!response.ok || !result.success) {
                    throw new Error(result.error?.message || 'ä¿å­˜å¤±è´¥');
                }
                
                console.log('âœ… Topic updated via API:', result.data);
                
                // Update sermon list via API
                const sermonsResponse = await fetch(`${APIConfig.baseURL}${APIConfig.apiVersion}/topics/${currentTopic.id}/sermons`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-API-Key': APIConfig.apiKey,
                        'X-Client-Type': APIConfig.clientType
                    },
                    body: JSON.stringify({ sermon_ids })
                });
                
                const sermonsResult = await sermonsResponse.json();
                
                if (!sermonsResponse.ok || !sermonsResult.success) {
                    throw new Error(sermonsResult.error?.message || 'ä¿å­˜sermonåˆ—è¡¨å¤±è´¥');
                }
                
                console.log('âœ… Topic sermons updated via API:', sermonsResult.data);
                
                // Reload all topics from API to get fresh data
                await loadTopics(currentPage);
                
                alert('ä¸»é¢˜ç»„æ›´æ”¹å·²ä¿å­˜ï¼\n\nçŠ¶æ€: ' + (status === 'active' ? 'å·²å¯ç”¨' : 'å·²ç¦ç”¨'));
                document.getElementById('edit-topic-modal').close();
            } catch (error) {
                console.error('Failed to save topic changes:', error);
                alert(`ä¿å­˜å¤±è´¥ï¼š${error.message}`);
            }
        }

        // Add Sermon Modal Functions
        async function openAddSermonModal() {
            await loadAvailableSermons();
            document.getElementById('add-sermon-modal').showModal();
        }
        
        async function loadAvailableSermons() {
            try {
                const response = await fetch(`${APIConfig.baseURL}${APIConfig.apiVersion}/sermons?_limit=10000`);
                const data = await response.json();
                const allSermons = data.data || data;
                
                console.log('ğŸ“Š All sermons:', allSermons.length);
                
                // Get current topic's sermon IDs
                const currentSermonIds = new Set();
                const tbody = document.getElementById('sermons-table-body');
                const rows = tbody.querySelectorAll('tr');
                
                // Only get IDs from actual sermon rows, not from empty state messages
                rows.forEach(row => {
                    const checkbox = row.querySelector('input[data-id]');
                    if (checkbox) {
                        currentSermonIds.add(checkbox.getAttribute('data-id'));
                    }
                });
                
                console.log('ğŸ” Current sermon IDs:', Array.from(currentSermonIds));
                
                // Filter out sermons already in this topic (æ˜¾ç¤ºæ‰€æœ‰çŠ¶æ€çš„è®²é“)
                const availableSermons = allSermons.filter(sermon => !currentSermonIds.has(sermon.id));
                console.log('âœ… Available sermons:', availableSermons.length);
                
                // Render available sermons
                renderAvailableSermons(availableSermons);
            } catch (error) {
                console.error('Failed to load available sermons:', error);
                document.getElementById('available-sermons-body').innerHTML = `
                    <tr>
                        <td colspan="5" class="text-center py-8 text-base-content/70">
                            åŠ è½½è®²é“å¤±è´¥: ${error.message}
                        </td>
                    </tr>
                `;
            }
        }
        
        function renderAvailableSermons(sermons) {
            const tbody = document.getElementById('available-sermons-body');
            
            if (sermons.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="5" class="text-center py-8 text-base-content/70">
                            æ²¡æœ‰å¯æ·»åŠ çš„è®²é“
                        </td>
                    </tr>
                `;
                return;
            }
            
            tbody.innerHTML = sermons.map(sermon => {
                const uploadDate = new Date(sermon.created_at).toLocaleDateString('zh-CN');
                
                // Normalize status to Chinese
                let displayStatus = sermon.status;
                if (sermon.status === 'published') {
                    displayStatus = 'å·²å‘å¸ƒ';
                } else if (sermon.status === 'pending') {
                    displayStatus = 'å¾…å®¡æ ¸';
                } else if (sermon.status === 'rejected') {
                    displayStatus = 'å·²æ‹’ç»';
                }
                
                return `
                    <tr class="hover">
                        <td><input type="checkbox" class="checkbox checkbox-sm available-sermon-checkbox" data-id="${sermon.id}" data-title="${sermon.title}" data-speaker="${sermon.speaker?.name || 'æœªçŸ¥è®²å‘˜'}"></td>
                        <td>
                            <div class="flex items-center gap-2">
                                <span class="font-medium">${sermon.title}</span>
                            </div>
                        </td>
                        <td>${sermon.speaker?.name || 'æœªçŸ¥è®²å‘˜'}</td>
                        <td>${uploadDate}</td>
                        <td><span class="badge badge-success badge-sm">${displayStatus}</span></td>
                    </tr>
                `;
            }).join('');
        }

        function searchAvailableSermons() {
            const searchTerm = document.getElementById('add-sermon-search').value.toLowerCase();
            const rows = document.querySelectorAll('#available-sermons-body tr');
            
            rows.forEach(row => {
                const title = row.querySelector('td:nth-child(2)')?.textContent.toLowerCase() || '';
                const speaker = row.querySelector('td:nth-child(3)')?.textContent.toLowerCase() || '';
                
                if (title.includes(searchTerm) || speaker.includes(searchTerm)) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        }

        function toggleSelectAllAvailable(checkbox) {
            const checkboxes = document.querySelectorAll('.available-sermon-checkbox');
            checkboxes.forEach(cb => {
                if (cb.closest('tr').style.display !== 'none') {
                    cb.checked = checkbox.checked;
                }
            });
            updateAddSelectedCount();
        }

        function updateAddSelectedCount() {
            const checkboxes = document.querySelectorAll('.available-sermon-checkbox:checked');
            document.getElementById('add-selected-count').textContent = checkboxes.length;
        }

        async function confirmAddSermons() {
            const checkboxes = document.querySelectorAll('.available-sermon-checkbox:checked');
            if (checkboxes.length === 0) {
                alert('è¯·é€‰æ‹©è¦æ·»åŠ çš„è®²é“');
                return;
            }

            // Get sermon data from checkboxes
            const selectedSermons = Array.from(checkboxes).map(checkbox => ({
                id: checkbox.getAttribute('data-id'),
                title: checkbox.getAttribute('data-title'),
                speaker: checkbox.getAttribute('data-speaker')
            }));

            // Fetch full sermon data for duration and status
            try {
                const response = await fetch(`${APIConfig.baseURL}${APIConfig.apiVersion}/sermons?_limit=10000`);
                const data = await response.json();
                const allSermons = data.data || data;
                
                // Add selected sermons to the main table
                selectedSermons.forEach(selected => {
                    const sermon = allSermons.find(s => s.id === selected.id);
                    if (!sermon) return;
                    
                    const duration = sermon.duration ? `${Math.floor(sermon.duration / 60)}:${(sermon.duration % 60).toString().padStart(2, '0')}` : '--:--';
                    
                    // Normalize status to Chinese
                    let displayStatus = sermon.status;
                    if (sermon.status === 'published') {
                        displayStatus = 'å·²å‘å¸ƒ';
                    } else if (sermon.status === 'pending') {
                        displayStatus = 'å¾…å®¡æ ¸';
                    } else if (sermon.status === 'rejected') {
                        displayStatus = 'å·²æ‹’ç»';
                    }
                    
                    const statusBadge = displayStatus === 'å·²å‘å¸ƒ' ? 'badge-success' : 'badge-warning';
                    
                    // Create new row in sermons table
                    const newRow = document.createElement('tr');
                    newRow.className = 'hover';
                    newRow.innerHTML = `
                        <td><input type="checkbox" class="checkbox checkbox-sm sermon-checkbox" data-id="${sermon.id}"></td>
                        <td>
                            <div class="flex items-center gap-2">
                                <span class="font-medium">${sermon.title}</span>
                            </div>
                        </td>
                        <td>${sermon.speaker?.name || 'æœªçŸ¥è®²å‘˜'}</td>
                        <td>${duration}</td>
                        <td><span class="badge ${statusBadge} badge-sm">${displayStatus}</span></td>
                        <td class="text-center">
                            <button class="btn btn-ghost btn-xs text-error" onclick="removeSermonFromTopic('${sermon.id}')">
                                <span class="iconify" data-icon="heroicons:trash" data-width="14"></span>
                                ç§»é™¤
                            </button>
                        </td>
                    `;
                    document.getElementById('sermons-table-body').appendChild(newRow);
                });

                // æ›´æ–°æ˜¾ç¤ºçš„è®²é“æ•°é‡ï¼ˆå®é™…ä¿å­˜ä¼šåœ¨ç‚¹å‡»"ä¿å­˜æ›´æ”¹"æ—¶é€šè¿‡ API å®Œæˆï¼‰
                updateSermonCount();
                updateAddSelectedCount();
                
                // Close the "è¯¥ä¸»é¢˜ç»„æš‚æ— è®²é“" message by updating the UI
                // Check if the table is showing empty state
                const tbody = document.getElementById('sermons-table-body');
                const emptyRow = tbody.querySelector('td[colspan="6"]');
                if (emptyRow) {
                    // Remove the empty state message since we just added sermons
                    emptyRow.closest('tr').remove();
                }
                
                // Uncheck checkboxes
                checkboxes.forEach(cb => cb.checked = false);
                
                alert(`æˆåŠŸæ·»åŠ  ${checkboxes.length} ç¯‡è®²é“åˆ°ä¸»é¢˜ç»„ï¼ˆè¯·ç‚¹å‡»"ä¿å­˜æ›´æ”¹"ä»¥ä¿å­˜åˆ°æ•°æ®åº“ï¼‰`);
                document.getElementById('add-sermon-modal').close();
            } catch (error) {
                console.error('Failed to add sermons:', error);
                alert('æ·»åŠ è®²é“å¤±è´¥ï¼Œè¯·é‡è¯•');
            }
        }
        
        function removeSermonFromTopic(sermonId) {
            if (!confirm('ç¡®å®šè¦ä»ä¸»é¢˜ç»„ä¸­ç§»é™¤è¿™ç¯‡è®²é“å—ï¼Ÿ')) {
                return;
            }
            
            // Remove from UI
            const row = document.querySelector(`input[data-id="${sermonId}"]`)?.closest('tr');
            if (row) {
                row.remove();
            }
            
            // æ›´æ–°æ˜¾ç¤ºçš„è®²é“æ•°é‡ï¼ˆå®é™…ä¿å­˜ä¼šåœ¨ç‚¹å‡»"ä¿å­˜æ›´æ”¹"æ—¶é€šè¿‡ API å®Œæˆï¼‰
            updateSermonCount();
            
            alert('è®²é“å·²ç§»é™¤ï¼ˆè¯·ç‚¹å‡»"ä¿å­˜æ›´æ”¹"ä»¥ä¿å­˜åˆ°æ•°æ®åº“ï¼‰');
        }

        // Create Topic Modal Functions
        function openCreateModal() {
            // Reset form
            document.getElementById('new-topic-name').value = '';
            document.getElementById('new-topic-description').value = '';
            document.getElementById('new-topic-icon').value = '';
            document.getElementById('new-topic-status').value = 'active';
            
            document.getElementById('create-topic-modal').showModal();
        }

        async function createTopic() {
            const name = document.getElementById('new-topic-name').value.trim();
            const description = document.getElementById('new-topic-description').value.trim();
            const status = document.getElementById('new-topic-status').value;
            const iconFile = document.getElementById('new-topic-icon').files[0];
            
            if (!name) {
                alert('è¯·è¾“å…¥ä¸»é¢˜ç»„åç§°');
                return;
            }
            
            // Upload icon to R2 if provided
            let iconUrl = null;
            if (iconFile) {
                try {
                    const formData = new FormData();
                    formData.append('file', iconFile);  // ä¿®æ”¹ä¸º 'file' ä»¥åŒ¹é…åç«¯ API
                    formData.append('type', 'topic');  // æŒ‡å®šç±»å‹
                    
                    const uploadResponse = await fetch(`${APIConfig.baseURL}${APIConfig.apiVersion}/upload/image`, {
                        method: 'POST',
                        headers: {
                            'X-API-Key': APIConfig.apiKey,
                            'X-Client-Type': APIConfig.clientType
                        },
                        body: formData
                    });
                    
                    if (!uploadResponse.ok) {
                        const errorData = await uploadResponse.json();
                        throw new Error(errorData.error?.message || 'Icon upload failed');
                    }
                    
                    const uploadResult = await uploadResponse.json();
                    iconUrl = uploadResult.data?.url || uploadResult.url;
                    console.log('Icon uploaded to R2:', iconUrl);
                } catch (error) {
                    console.error('Failed to upload icon:', error);
                    alert('å›¾æ ‡ä¸Šä¼ å¤±è´¥ï¼š' + error.message);
                    return;
                }
            }
            
            // Create new topic object
            const topicId = `topic-${Date.now()}-${Math.floor(Math.random() * 1000)}`;
            const newTopic = {
                id: topicId,
                name: name,
                name_en: name,
                slug: name.toLowerCase().replace(/\s+/g, '-'),
                description: description || '',
                cover_image_url: iconUrl || null,
                icon: iconUrl || 'folder',
                color: '#60A5FA',
                parent_id: null,
                is_featured: false,
                display_order: allTopics.length + 1,
                status: status
            };
            
            try {
                // Call API to create topic
                const response = await fetch(`${APIConfig.baseURL}${APIConfig.apiVersion}/topics`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-API-Key': APIConfig.apiKey,
                        'X-Client-Type': APIConfig.clientType
                    },
                    body: JSON.stringify(newTopic)
                });
                
                const result = await response.json();
                
                if (!response.ok || !result.success) {
                    throw new Error(result.error?.message || 'åˆ›å»ºå¤±è´¥');
                }
                
                console.log('âœ… Topic created via API:', result.data);
                
                // Reload all topics from API to get fresh data
                await loadTopics(1);
                
                alert(`ä¸»é¢˜ç»„åˆ›å»ºæˆåŠŸï¼\n\nåç§°: ${result.data.name}\nçŠ¶æ€: ${result.data.status === 'active' ? 'å·²å¯ç”¨' : 'å·²ç¦ç”¨'}`);
                document.getElementById('create-topic-modal').close();
            } catch (error) {
                console.error('Failed to create topic:', error);
                alert(`åˆ›å»ºä¸»é¢˜ç»„å¤±è´¥ï¼š${error.message}`);
            }
        }
        
        // Load custom topics on page load
        document.addEventListener('DOMContentLoaded', () => {
            loadTopics(1);
            
            // Event delegation for edit buttons
            document.querySelector('tbody').addEventListener('click', (e) => {
                const editBtn = e.target.closest('.edit-topic-btn');
                if (editBtn) {
                    const topicId = editBtn.getAttribute('data-topic-id');
                    const topicName = editBtn.getAttribute('data-topic-name');
                    const sermonCount = editBtn.getAttribute('data-sermon-count');
                    openEditModal(topicId, topicName, parseInt(sermonCount));
                }
            });
        });
    </script>
</body>
</html>

